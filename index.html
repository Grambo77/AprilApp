<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Pink Pony Fractals</title>

  <!-- ============================================
       PWA META TAGS
       These tell browsers/OS how to handle the app
       when installed to home screen.
  ============================================ -->
  <!-- Manifest: defines app name, icons, colors, display mode -->
  <link rel="manifest" href="manifest.json">
  <!-- Theme color: colors the Android status bar / browser toolbar -->
  <meta name="theme-color" content="#ff2d6b">
  <!-- Apple-specific: makes iOS treat it as a standalone app -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PonyFractals">
  <!-- Apple touch icon: what shows on iOS home screen -->
  <link rel="apple-touch-icon" href="icon-192.png">

  <!-- Preload fonts so they're ready before first paint -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,700&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
  <style>
    /* ============================================
       CHAPPELL ROAN AESTHETIC ‚Äî PHASE 2
       Maximalist camp: neon pinks, glitter golds,
       deep blacks, drag-queen-at-the-county-fair
       energy. Think: neon motel sign meets
       vintage Hollywood glamour.
    ============================================ */

    /* -- Theme palettes as CSS custom properties --
       Each palette changes the entire UI + fractal
       colors in one swap. The JS toggles a class
       on <body> to switch between them. */
    :root {
      /* Pink Pony Club ‚Äî signature hot pink neon */
      --bg-dark: #0a0007;
      --primary: #ff2d6b;
      --primary-glow: rgba(255, 45, 107, 0.4);
      --accent: #ff69b4;
      --accent-soft: #ffb6d9;
      --highlight: #ffd700;
      --surface: rgba(255, 45, 107, 0.12);
      --surface-border: rgba(255, 45, 107, 0.4);
      --text-primary: #fff0f5;
      --text-muted: rgba(255, 182, 217, 0.5);
      --gradient-deep: #2d0a31;
    }

    body.theme-redwine {
      /* Red Wine Supernova ‚Äî deep reds, amber, gold */
      --primary: #dc143c;
      --primary-glow: rgba(220, 20, 60, 0.4);
      --accent: #ff6347;
      --accent-soft: #ffb088;
      --highlight: #ffc107;
      --surface: rgba(220, 20, 60, 0.12);
      --surface-border: rgba(220, 20, 60, 0.4);
      --text-primary: #fff5ee;
      --text-muted: rgba(255, 176, 136, 0.5);
      --gradient-deep: #1a0005;
    }

    body.theme-midwest {
      /* Midwest Princess ‚Äî dreamy pastels, lavender */
      --primary: #c77dff;
      --primary-glow: rgba(199, 125, 255, 0.4);
      --accent: #e0aaff;
      --accent-soft: #f0d6ff;
      --highlight: #80ffdb;
      --surface: rgba(199, 125, 255, 0.12);
      --surface-border: rgba(199, 125, 255, 0.4);
      --text-primary: #f8f0ff;
      --text-muted: rgba(224, 170, 255, 0.5);
      --gradient-deep: #10002b;
    }

    body.theme-goodluck {
      /* Good Luck, Babe! ‚Äî teal, coral, sunset warmth */
      --primary: #ff6b6b;
      --primary-glow: rgba(255, 107, 107, 0.4);
      --accent: #ffa07a;
      --accent-soft: #ffd4c4;
      --highlight: #20b2aa;
      --surface: rgba(255, 107, 107, 0.12);
      --surface-border: rgba(255, 107, 107, 0.4);
      --text-primary: #fff5f0;
      --text-muted: rgba(255, 160, 122, 0.5);
      --gradient-deep: #1a0a0a;
    }

    body.theme-femininomenon {
      /* Femininomenon ‚Äî electric blue, magenta, cyber */
      --primary: #00d4ff;
      --primary-glow: rgba(0, 212, 255, 0.4);
      --accent: #00e5ff;
      --accent-soft: #b0f0ff;
      --highlight: #ff00aa;
      --surface: rgba(0, 212, 255, 0.12);
      --surface-border: rgba(0, 212, 255, 0.4);
      --text-primary: #f0fcff;
      --text-muted: rgba(0, 229, 255, 0.5);
      --gradient-deep: #000a14;
    }

    body.theme-naked {
      /* Naked in Manhattan ‚Äî warm amber, champagne, gold */
      --primary: #e8a317;
      --primary-glow: rgba(232, 163, 23, 0.4);
      --accent: #f0c75e;
      --accent-soft: #ffe4a0;
      --highlight: #ff8c69;
      --surface: rgba(232, 163, 23, 0.12);
      --surface-border: rgba(232, 163, 23, 0.4);
      --text-primary: #fffcf0;
      --text-muted: rgba(240, 199, 94, 0.5);
      --gradient-deep: #140e00;
    }

    /* ---- SABRINA CARPENTER THEMES ---- */
    body.theme-espresso {
      /* Espresso ‚Äî rich coffee browns, cream, caramel */
      --bg-dark: #0e0804;
      --primary: #c48a3f;
      --primary-glow: rgba(196, 138, 63, 0.4);
      --accent: #daa06d;
      --accent-soft: #f0d5a8;
      --highlight: #fff5e1;
      --surface: rgba(196, 138, 63, 0.12);
      --surface-border: rgba(196, 138, 63, 0.4);
      --text-primary: #fff8f0;
      --text-muted: rgba(218, 160, 109, 0.5);
      --gradient-deep: #1a0e02;
    }

    body.theme-pleasepleasepl {
      /* Please Please Please ‚Äî vintage blush, rose gold, cream */
      --primary: #e8838a;
      --primary-glow: rgba(232, 131, 138, 0.4);
      --accent: #f4b4b8;
      --accent-soft: #fddede;
      --highlight: #c9a96e;
      --surface: rgba(232, 131, 138, 0.12);
      --surface-border: rgba(232, 131, 138, 0.4);
      --text-primary: #fff5f5;
      --text-muted: rgba(244, 180, 184, 0.5);
      --gradient-deep: #1a0808;
    }

    body.theme-taste {
      /* Taste ‚Äî bold cherry red, cream, black */
      --primary: #cc0033;
      --primary-glow: rgba(204, 0, 51, 0.4);
      --accent: #ff3355;
      --accent-soft: #ff8899;
      --highlight: #ffe6cc;
      --surface: rgba(204, 0, 51, 0.12);
      --surface-border: rgba(204, 0, 51, 0.4);
      --text-primary: #fff0f3;
      --text-muted: rgba(255, 51, 85, 0.5);
      --gradient-deep: #180008;
    }

    body.theme-nonsense {
      /* Nonsense ‚Äî playful lavender, bubblegum, sparkle */
      --primary: #b366ff;
      --primary-glow: rgba(179, 102, 255, 0.4);
      --accent: #ff85c8;
      --accent-soft: #ffbee6;
      --highlight: #66ffcc;
      --surface: rgba(179, 102, 255, 0.12);
      --surface-border: rgba(179, 102, 255, 0.4);
      --text-primary: #f8f0ff;
      --text-muted: rgba(255, 133, 200, 0.5);
      --gradient-deep: #0f0020;
    }

    body.theme-feather {
      /* Feather ‚Äî airy sky blue, white, soft gold */
      --primary: #5ba8c8;
      --primary-glow: rgba(91, 168, 200, 0.4);
      --accent: #8ed1e0;
      --accent-soft: #c8eef5;
      --highlight: #f0d080;
      --surface: rgba(91, 168, 200, 0.12);
      --surface-border: rgba(91, 168, 200, 0.4);
      --text-primary: #f0faff;
      --text-muted: rgba(142, 209, 224, 0.5);
      --gradient-deep: #040e14;
    }

    body.theme-shortnsw {
      /* Short n' Sweet ‚Äî golden blonde, peach, warm white */
      --primary: #e0a830;
      --primary-glow: rgba(224, 168, 48, 0.4);
      --accent: #f5c96a;
      --accent-soft: #ffe8b0;
      --highlight: #ff9e80;
      --surface: rgba(224, 168, 48, 0.12);
      --surface-border: rgba(224, 168, 48, 0.4);
      --text-primary: #fffdf5;
      --text-muted: rgba(245, 201, 106, 0.5);
      --gradient-deep: #141000;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: var(--bg-dark);
      color: var(--text-primary);
      font-family: 'DM Mono', 'Courier New', monospace;
      overflow: hidden;
      height: 100vh;
      height: 100dvh;
      width: 100vw;
      overscroll-behavior: none;
      touch-action: none;
      transition: background 0.6s ease;
    }

    /* ============================================
       FRACTAL CANVAS
       Pixelated upscale gives retro chunky look
    ============================================ */
    #fractalCanvas {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 1;
      /* Smooth bilinear upscale gives a dreamy soft-glow
         feel instead of harsh pixel edges */
      image-rendering: auto;
    }

    /* ============================================
       SPARKLE OVERLAY
       Full-res canvas for floating glitter particles.
       Separated so sparkles are crisp while fractals
       stay chunky.
    ============================================ */
    #sparkleCanvas {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 2;
      pointer-events: none;
    }

    /* ============================================
       UI OVERLAY ‚Äî shared positioning base
    ============================================ */
    .ui-overlay {
      position: fixed;
      z-index: 10;
      pointer-events: none;
      /* Smooth show/hide transitions */
      transition: opacity 0.4s ease;
    }

    .ui-overlay.ui-hidden {
      opacity: 0;
      pointer-events: none !important;
    }

    /* -- Top bar -- */
    .top-bar {
      top: 0; left: 0; right: 0;
      padding: 16px 20px;
      padding-top: max(16px, env(safe-area-inset-top));
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      background: linear-gradient(to bottom,
        rgba(10, 0, 7, 0.75) 0%,
        rgba(10, 0, 7, 0.3) 60%,
        transparent 100%);
    }

    .app-title {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.3rem;
      font-weight: 700;
      font-style: italic;
      letter-spacing: 0.03em;
      color: var(--accent);
      text-shadow:
        0 0 10px var(--primary),
        0 0 30px var(--primary-glow);
      animation: titleGlow 3s ease-in-out infinite alternate;
    }

    @keyframes titleGlow {
      0% { text-shadow: 0 0 10px var(--primary), 0 0 30px var(--primary-glow); }
      100% { text-shadow: 0 0 15px var(--primary), 0 0 50px var(--primary-glow), 0 0 80px var(--primary-glow); }
    }

    /* -- Mic status badge with frosted glass -- */
    .mic-status {
      font-size: 0.7rem;
      padding: 5px 12px;
      border-radius: 20px;
      background: var(--surface);
      border: 1px solid var(--surface-border);
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .mic-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--primary);
      animation: pulse 1.5s ease-in-out infinite;
      box-shadow: 0 0 6px var(--primary);
    }

    .mic-dot.inactive {
      background: #444;
      animation: none;
      box-shadow: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.4; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.3); }
    }

    /* ============================================
       AUDIO LEVEL METER
       Thin bar at top edge ‚Äî immediate visual
       proof that mic input is being captured.
    ============================================ */
    .audio-meter {
      position: fixed;
      top: 0; left: 0;
      height: 3px;
      width: 0%;
      z-index: 20;
      background: linear-gradient(to right, var(--primary), var(--highlight));
      box-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary-glow);
      transition: width 0.1s ease-out;
    }

    /* ============================================
       BOTTOM CONTROLS
    ============================================ */
    .bottom-bar {
      bottom: 0; left: 0; right: 0;
      padding: 16px 20px;
      padding-bottom: max(16px, env(safe-area-inset-bottom));
      background: linear-gradient(to top,
        rgba(10, 0, 7, 0.85) 0%,
        rgba(10, 0, 7, 0.4) 60%,
        transparent 100%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }

    .fractal-info {
      font-size: 0.6rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.2em;
    }

    .controls {
      display: flex;
      gap: 8px;
      pointer-events: auto;
      flex-wrap: wrap;
      justify-content: center;
    }

    .btn {
      background: var(--surface);
      border: 1px solid var(--surface-border);
      color: var(--accent);
      padding: 9px 14px;
      border-radius: 22px;
      font-family: 'DM Mono', monospace;
      font-size: 0.7rem;
      font-weight: 300;
      cursor: pointer;
      transition: all 0.25s ease;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      user-select: none;
      -webkit-user-select: none;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn:hover, .btn:active {
      background: var(--primary);
      color: var(--bg-dark);
      border-color: var(--primary);
      box-shadow: 0 0 20px var(--primary-glow);
    }

    .btn.active {
      background: var(--primary);
      color: var(--bg-dark);
      border-color: var(--primary);
      box-shadow: 0 0 15px var(--primary-glow);
    }

    .btn-icon { font-size: 0.9rem; line-height: 1; }

    /* -- Sensitivity slider -- */
    .slider-row {
      display: flex;
      align-items: center;
      gap: 10px;
      pointer-events: auto;
      width: 70%;
      max-width: 260px;
    }

    .slider-label {
      font-size: 0.55rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      white-space: nowrap;
    }

    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 3px;
      background: linear-gradient(to right, var(--primary), var(--highlight));
      border-radius: 2px;
      outline: none;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    input[type="range"]:active { opacity: 1; }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px; height: 16px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 0 8px var(--primary);
    }

    /* ============================================
       START SCREEN
    ============================================ */
    .start-prompt {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 100;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 20px;
      text-align: center;
      padding: 30px;
      background:
        radial-gradient(ellipse at 30% 20%, rgba(255, 45, 107, 0.15), transparent 50%),
        radial-gradient(ellipse at 70% 80%, rgba(255, 215, 0, 0.08), transparent 50%),
        radial-gradient(ellipse at center, var(--gradient-deep), var(--bg-dark));
      transition: opacity 0.6s ease, transform 0.6s ease;
    }

    .start-prompt.leaving {
      opacity: 0;
      transform: scale(1.05);
    }

    .start-prompt.hidden { display: none !important; }

    .start-stars {
      font-size: 1.2rem;
      letter-spacing: 0.6em;
      color: var(--highlight);
      opacity: 0.6;
      animation: twinkle 2s ease-in-out infinite alternate;
    }

    @keyframes twinkle {
      0% { opacity: 0.3; }
      100% { opacity: 0.8; }
    }

    .start-prompt h1 {
      font-family: 'Playfair Display', Georgia, serif;
      font-style: italic;
      font-size: clamp(2rem, 8vw, 3.5rem);
      font-weight: 700;
      color: var(--accent);
      text-shadow:
        0 0 20px var(--primary),
        0 0 60px var(--primary-glow),
        0 0 100px rgba(255, 45, 107, 0.15);
      line-height: 1.15;
    }

    .start-subtitle {
      font-family: 'DM Mono', monospace;
      font-size: 0.75rem;
      font-weight: 300;
      color: var(--accent-soft);
      letter-spacing: 0.15em;
      text-transform: uppercase;
      max-width: 280px;
      line-height: 1.8;
    }

    .start-btn {
      background: var(--primary);
      color: var(--bg-dark);
      border: none;
      padding: 14px 44px;
      border-radius: 30px;
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.05rem;
      font-weight: 700;
      font-style: italic;
      cursor: pointer;
      letter-spacing: 0.06em;
      transition: all 0.3s ease;
      box-shadow:
        0 0 30px var(--primary-glow),
        inset 0 0 30px rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
      margin-top: 8px;
    }

    .start-btn:hover, .start-btn:active {
      transform: scale(1.06);
      box-shadow:
        0 0 50px var(--primary-glow),
        0 0 100px var(--primary-glow),
        inset 0 0 30px rgba(255, 255, 255, 0.15);
    }

    /* Sheen sweep on button */
    .start-btn::after {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 60%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.25), transparent);
      animation: sheen 3s ease-in-out infinite;
    }

    @keyframes sheen {
      0% { left: -100%; }
      50% { left: 150%; }
      100% { left: 150%; }
    }

    .start-note {
      font-size: 0.6rem;
      color: var(--text-muted);
      max-width: 240px;
      line-height: 1.5;
    }

    /* ============================================
       QUOTE OVERLAY
       Centered text that fades in/out over the
       fractal. Uses CSS animations for smooth
       transitions between quotes.
    ============================================ */
    .quote-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 3; /* Above sparkles, below UI */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 40px 30px;
      pointer-events: none;
      /* Dim the fractal slightly so text is readable */
      background: radial-gradient(
        ellipse at center,
        rgba(10, 0, 7, 0.5) 0%,
        rgba(10, 0, 7, 0.2) 60%,
        transparent 100%
      );
      opacity: 0;
      transition: opacity 0.8s ease;
    }

    .quote-overlay.visible {
      opacity: 1;
    }

    .quote-text {
      font-family: 'Playfair Display', Georgia, serif;
      font-style: italic;
      font-size: clamp(1.3rem, 5vw, 2.2rem);
      font-weight: 700;
      color: var(--text-primary);
      text-shadow:
        0 0 20px var(--primary),
        0 0 40px var(--primary-glow),
        0 2px 10px rgba(0, 0, 0, 0.8);
      line-height: 1.4;
      max-width: 600px;
      /* Individual quote fade animation */
      animation: quoteFade 1s ease-out;
    }

    @keyframes quoteFade {
      0% { opacity: 0; transform: translateY(12px) scale(0.97); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    .quote-source {
      margin-top: 16px;
      font-family: 'DM Mono', monospace;
      font-size: 0.65rem;
      font-weight: 300;
      color: var(--highlight);
      text-transform: uppercase;
      letter-spacing: 0.2em;
      opacity: 0.7;
    }

    /* ============================================
       CUSTOM QUOTES MODAL
       Slide-up panel for adding/removing quotes.
       Frosted glass background, theme-aware.
    ============================================ */
    .modal-backdrop {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 50;
      background: rgba(10, 0, 7, 0.7);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .modal-backdrop.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .modal {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      z-index: 51;
      max-height: 70vh;
      background: linear-gradient(to bottom, rgba(45, 10, 49, 0.95), rgba(10, 0, 7, 0.98));
      border-top: 1px solid var(--surface-border);
      border-radius: 20px 20px 0 0;
      padding: 24px 20px;
      padding-bottom: max(24px, env(safe-area-inset-bottom));
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .modal-backdrop.visible .modal {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-family: 'Playfair Display', Georgia, serif;
      font-style: italic;
      font-size: 1.1rem;
      color: var(--accent);
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 4px 8px;
      line-height: 1;
    }

    .modal-close:hover { color: var(--accent); }

    /* Input row for adding new quotes */
    .add-quote-row {
      display: flex;
      gap: 8px;
    }

    .add-quote-row input {
      flex: 1;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--surface-border);
      border-radius: 12px;
      padding: 10px 14px;
      color: var(--text-primary);
      font-family: 'DM Mono', monospace;
      font-size: 0.75rem;
      outline: none;
      transition: border-color 0.2s;
    }

    .add-quote-row input:focus {
      border-color: var(--primary);
    }

    .add-quote-row input::placeholder {
      color: var(--text-muted);
    }

    .add-quote-row button {
      background: var(--primary);
      color: var(--bg-dark);
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      font-family: 'DM Mono', monospace;
      font-size: 0.75rem;
      font-weight: 400;
      cursor: pointer;
      white-space: nowrap;
      transition: opacity 0.2s;
    }

    .add-quote-row button:hover { opacity: 0.85; }

    /* List of existing quotes */
    .quote-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 35vh;
      overflow-y: auto;
    }

    .quote-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: 10px;
      font-size: 0.7rem;
      color: var(--accent-soft);
      line-height: 1.4;
    }

    .quote-item-text {
      flex: 1;
      /* Show the quote and source on separate lines */
    }

    .quote-item-source {
      font-size: 0.6rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .quote-delete {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1rem;
      cursor: pointer;
      padding: 2px 6px;
      flex-shrink: 0;
      transition: color 0.2s;
    }

    .quote-delete:hover { color: var(--primary); }

    .hidden { display: none !important; }

    /* ============================================
       CAMERA MODE
       Full-screen camera view with color filter
       overlay. Uses a hidden <video> element as
       source and draws filtered frames to a canvas.
    ============================================ */
    .camera-layer {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 30;
      background: var(--bg-dark);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
    }

    .camera-layer.active {
      opacity: 1;
      pointer-events: auto;
    }

    #cameraCanvas {
      /* Canvas fills the entire camera layer.
         We handle aspect ratio in JS by scaling
         the drawImage call to cover the canvas,
         since object-fit doesn't work on canvas. */
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
    }

    /* Camera-specific bottom controls */
    .camera-controls {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      z-index: 35;
      padding: 20px;
      padding-bottom: max(20px, env(safe-area-inset-bottom));
      background: linear-gradient(to top,
        rgba(10, 0, 7, 0.9) 0%,
        rgba(10, 0, 7, 0.4) 70%,
        transparent 100%);
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
    }

    .camera-controls.active {
      opacity: 1;
      pointer-events: auto;
    }

    .camera-filter-name {
      font-size: 1.2rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.2em;
    }

    .camera-frame-name {
      font-size: 0.6rem;
      color: var(--highlight);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      min-height: 1em;
      opacity: 0.7;
    }

    .camera-btn-row {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
    }

    /* Large shutter button ‚Äî centered, prominent */
    .shutter-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: transparent;
      border: 3px solid var(--accent);
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    /* Inner circle of shutter button */
    .shutter-btn::after {
      content: '';
      position: absolute;
      top: 5px; left: 5px; right: 5px; bottom: 5px;
      border-radius: 50%;
      background: var(--accent);
      transition: all 0.15s ease;
    }

    .shutter-btn:active::after {
      transform: scale(0.85);
      background: var(--primary);
    }

    /* Camera flash overlay for photo capture feedback */
    .camera-flash {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 40;
      background: white;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.1s ease;
    }

    .camera-flash.flash {
      opacity: 0.7;
      transition: none;
    }

    /* ============================================
       TRIVIA MODE
       Full-screen quiz overlay with themed styling.
       Sits on top of the fractal (which keeps
       auto-animating behind it as a backdrop).
    ============================================ */
    .trivia-layer {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 30;
      background: rgba(10, 2, 15, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      padding-top: max(20px, env(safe-area-inset-top));
      padding-bottom: max(20px, env(safe-area-inset-bottom));
      overflow-y: auto;
    }

    .trivia-layer.active {
      opacity: 1;
      pointer-events: auto;
    }

    .trivia-card {
      width: 100%;
      max-width: 500px;
      text-align: center;
    }

    .trivia-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-family: 'DM Mono', monospace;
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.15em;
    }

    .trivia-progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      margin-bottom: 24px;
      overflow: hidden;
    }

    .trivia-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 2px;
      transition: width 0.4s ease;
    }

    .trivia-category {
      font-family: 'DM Mono', monospace;
      font-size: 0.6rem;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.2em;
      margin-bottom: 8px;
    }

    .trivia-question {
      font-family: 'Playfair Display', serif;
      font-style: italic;
      font-size: 1.2rem;
      color: var(--text-light);
      line-height: 1.5;
      margin-bottom: 28px;
      min-height: 3.6em;
    }

    .trivia-answers {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .trivia-answer-btn {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      padding: 14px 18px;
      color: var(--text-light);
      font-family: 'DM Mono', monospace;
      font-size: 0.8rem;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .trivia-answer-btn:active {
      transform: scale(0.98);
    }

    .trivia-answer-btn.selected {
      border-color: var(--primary);
      background: rgba(255,255,255,0.1);
    }

    .trivia-answer-btn.correct {
      border-color: #4ade80;
      background: rgba(74, 222, 128, 0.15);
      color: #4ade80;
    }

    .trivia-answer-btn.wrong {
      border-color: #f87171;
      background: rgba(248, 113, 113, 0.15);
      color: #f87171;
    }

    .trivia-answer-btn.reveal {
      border-color: #4ade80;
      background: rgba(74, 222, 128, 0.08);
    }

    .trivia-answer-btn.disabled {
      pointer-events: none;
      opacity: 0.6;
    }

    .trivia-feedback {
      font-family: 'DM Mono', monospace;
      font-size: 0.75rem;
      color: var(--text-muted);
      min-height: 2.5em;
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .trivia-next-btn {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 10px 28px;
      color: var(--text-light);
      font-family: 'DM Mono', monospace;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
      opacity: 0;
      pointer-events: none;
    }

    .trivia-next-btn.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .trivia-next-btn:active {
      transform: scale(0.96);
    }

    /* Results screen at end of round */
    .trivia-results {
      text-align: center;
    }

    .trivia-score-big {
      font-family: 'Playfair Display', serif;
      font-style: italic;
      font-size: 3.5rem;
      color: var(--primary);
      text-shadow: 0 0 30px var(--primary);
      margin-bottom: 8px;
    }

    .trivia-score-label {
      font-family: 'DM Mono', monospace;
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.2em;
      margin-bottom: 24px;
    }

    .trivia-result-msg {
      font-family: 'Playfair Display', serif;
      font-style: italic;
      font-size: 1.1rem;
      color: var(--text-light);
      margin-bottom: 32px;
      line-height: 1.5;
    }

    .trivia-result-btns {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .trivia-result-btns .btn {
      min-width: 120px;
    }

    .trivia-close-btn {
      position: absolute;
      top: max(16px, env(safe-area-inset-top));
      right: 16px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 50%;
      width: 36px; height: 36px;
      color: var(--text-muted);
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .btn.selected {
      border-color: var(--primary);
      background: var(--surface);
      box-shadow: 0 0 10px var(--primary-glow);
      color: var(--text-primary);
    }

    .trivia-close-btn:active { transform: scale(0.9); }
  </style>
</head>
<body>

  <!-- START SCREEN -->
  <div class="start-prompt" id="startPrompt">
    <div class="start-stars">‚ú¶ ‚ú¶ ‚ú¶</div>
    <h1 id="startTitle">Pink Pony<br>Fractals</h1>
    <p class="start-subtitle" id="startSubtitle">a mic-reactive fractal visualizer</p>
    <div style="display:flex;gap:10px;justify-content:center;margin:16px 0 8px;">
      <button class="btn selected" id="pickChappell" style="pointer-events:auto;padding:10px 20px;font-size:0.75rem;">‚ú¶ Chappell Roan</button>
      <button class="btn" id="pickSabrina" style="pointer-events:auto;padding:10px 20px;font-size:0.75rem;">‚ú¶ Sabrina Carpenter</button>
    </div>
    <button class="start-btn" id="startBtn">‚ú¶ Enter ‚ú¶</button>
    <p class="start-note">Allow microphone access for the full audio-reactive experience</p>
  </div>

  <!-- Audio level meter -->
  <div class="audio-meter" id="audioMeter"></div>

  <!-- Fractal (low-res) -->
  <canvas id="fractalCanvas"></canvas>

  <!-- Sparkle particles (full-res) -->
  <canvas id="sparkleCanvas"></canvas>

  <!-- Quote overlay ‚Äî visible in quote mode -->
  <div class="quote-overlay" id="quoteOverlay">
    <div class="quote-text" id="quoteText"></div>
    <div class="quote-source" id="quoteSource"></div>
  </div>

  <!-- Custom quotes modal (slide-up panel) -->
  <div class="modal-backdrop" id="quoteModal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">‚ú¶ Your Quotes</span>
        <button class="modal-close" id="modalClose">√ó</button>
      </div>
      <div class="add-quote-row">
        <input type="text" id="newQuoteInput" placeholder="Add a favorite quote or lyric...">
        <button id="addQuoteBtn">Add ‚ú¶</button>
      </div>
      <div class="quote-list" id="quoteList"></div>
    </div>
  </div>

  <!-- Tap target for hiding UI ‚Äî invisible layer over canvases -->
  <div id="tapTarget" style="position:fixed;top:0;left:0;right:0;bottom:0;z-index:5;"></div>

  <!-- ============================================
       TRIVIA MODE
       Full-screen quiz overlay. Fractal keeps
       animating behind the frosted glass backdrop.
  ============================================ -->
  <div class="trivia-layer" id="triviaLayer">
    <button class="trivia-close-btn" id="triviaCloseBtn">√ó</button>
    <div class="trivia-card" id="triviaCard">
      <!-- Question view (shown during quiz) -->
      <div id="triviaQuestionView">
        <div class="trivia-header">
          <span id="triviaQNum">Question 1 / 10</span>
          <span id="triviaScore">Score: 0</span>
        </div>
        <div class="trivia-progress-bar">
          <div class="trivia-progress-fill" id="triviaProgress" style="width:10%"></div>
        </div>
        <div class="trivia-category" id="triviaCategory">‚ú¶ career ‚ú¶</div>
        <div class="trivia-question" id="triviaQuestion">Loading...</div>
        <div class="trivia-answers" id="triviaAnswers"></div>
        <div class="trivia-feedback" id="triviaFeedback"></div>
        <button class="trivia-next-btn" id="triviaNextBtn">Next ‚ú¶</button>
      </div>
      <!-- Results view (shown after 10 questions) -->
      <div id="triviaResultsView" class="trivia-results" style="display:none;">
        <div class="trivia-score-big" id="triviaFinalScore">8/10</div>
        <div class="trivia-score-label">Midwest Princess Rating</div>
        <div class="trivia-result-msg" id="triviaResultMsg">You really know your stuff!</div>
        <div class="trivia-result-btns">
          <button class="btn" id="triviaPlayAgain"><span class="btn-icon">‚ú¶</span> Play Again</button>
          <button class="btn" id="triviaExit"><span class="btn-icon">‚úï</span> Back to Fractals</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================
       CAMERA MODE
       Video element is hidden ‚Äî it's just the data
       source. We draw filtered frames to cameraCanvas.
  ============================================ -->
  <video id="cameraVideo" playsinline autoplay muted style="display:none;"></video>
  <div class="camera-layer" id="cameraLayer">
    <canvas id="cameraCanvas"></canvas>
  </div>
  <div class="camera-flash" id="cameraFlash"></div>

  <!-- Hidden file input ‚Äî triggers OS photo picker when clicked via JS -->
  <input type="file" id="photoInput" accept="image/*" style="display:none;">

  <!-- Live camera controls -->
  <div class="camera-controls" id="cameraControls">
    <div class="camera-filter-name" id="cameraFilterName">‚ú¶ Pink Pony Club ‚ú¶</div>
    <div class="camera-frame-name" id="cameraFrameName"></div>
    <div class="camera-btn-row">
      <button class="btn" id="btnCamFilter"><span class="btn-icon">‚ô¶</span> Filter</button>
      <button class="btn" id="btnCamFrame"><span class="btn-icon">‚ùë</span> Frame</button>
      <button class="shutter-btn" id="btnShutter"></button>
      <button class="btn" id="btnCamFlip"><span class="btn-icon">‚ü≥</span> Flip</button>
    </div>
    <button class="btn" id="btnCamClose"><span class="btn-icon">‚úï</span> Back to Fractals</button>
  </div>

  <!-- Photo editor controls (separate from live camera) -->
  <div class="camera-controls" id="editorControls">
    <div class="camera-filter-name" id="editorFilterName">‚ú¶ Pink Pony Club ‚ú¶</div>
    <div class="camera-frame-name" id="editorFrameName"></div>
    <div class="camera-btn-row">
      <button class="btn" id="btnEdFilter"><span class="btn-icon">‚ô¶</span> Filter</button>
      <button class="btn" id="btnEdFrame"><span class="btn-icon">‚ùë</span> Frame</button>
      <button class="shutter-btn" id="btnEdSave" title="Save photo"></button>
      <button class="btn" id="btnEdPick"><span class="btn-icon">üñº</span> New</button>
    </div>
    <button class="btn" id="btnEdClose"><span class="btn-icon">‚úï</span> Back to Fractals</button>
  </div>

  <!-- Top UI -->
  <div class="ui-overlay top-bar" id="topBar">
    <div class="app-title" id="appTitle">‚ú¶ Pink Pony Fractals</div>
    <div class="mic-status">
      <span class="mic-dot inactive" id="micDot"></span>
      <span id="micLabel">mic off</span>
    </div>
  </div>

  <!-- Bottom UI -->
  <div class="ui-overlay bottom-bar" id="bottomBar">
    <div class="fractal-info" id="fractalInfo">‚ú¶ Julia Set ¬∑ Pink Pony Club ‚ú¶</div>
    <div class="controls">
      <button class="btn" id="btnFractal"><span class="btn-icon">‚óá</span> Fractal</button>
      <button class="btn" id="btnColors"><span class="btn-icon">‚ô¶</span> Colors</button>
      <button class="btn" id="btnPalette"><span class="btn-icon">‚óà</span> UI</button>
      <button class="btn" id="btnMic"><span class="btn-icon">‚è∫</span> Mic</button>
      <button class="btn" id="btnQuotes"><span class="btn-icon">‚úß</span> Quotes</button>
      <button class="btn" id="btnEditQuotes"><span class="btn-icon">‚úé</span> Edit</button>
      <button class="btn" id="btnCamera"><span class="btn-icon">üì∑</span> Camera</button>
      <button class="btn" id="btnEditPhoto"><span class="btn-icon">üñº</span> Edit</button>
      <button class="btn" id="btnTrivia"><span class="btn-icon">?</span> Trivia</button>
      <button class="btn" id="btnFullscreen"><span class="btn-icon">‚õ∂</span> Full</button>
    </div>
    <div class="slider-row">
      <span class="slider-label">Sensitivity</span>
      <input type="range" id="sensitivity" min="1" max="100" value="50">
    </div>
  </div>

  <script>
    // ============================================
    // APP STATE ‚Äî single source of truth
    // ============================================
    const state = {
      micActive: false,
      audioContext: null,
      analyser: null,
      micStream: null,
      audioLevel: 0,
      bassLevel: 0,
      trebleLevel: 0,
      sensitivity: 1.0,
      fractalType: 0,
      paletteIndex: 0,   // Controls fractal + sparkle colors
      themeIndex: 0,      // Controls UI chrome colors (independent)
      time: 0,
      animFrame: null,
      uiVisible: true,
      // Quote mode
      quoteMode: false,
      quoteIndex: 0,
      quoteTimer: null,
      // Camera mode
      cameraActive: false,
      cameraStream: null,
      cameraAnimFrame: null,
      cameraFilterIndex: 0,
      cameraFrameIndex: 0,   // 0 = no frame, 1+ = frame styles
      facingMode: 'user',
      // Photo editor mode
      editorActive: false,
      editorImage: null,       // Stores the loaded Image object
      editorFilterIndex: 0,
      editorFrameIndex: 0,  // 'user' = front, 'environment' = back
    };

    const FRACTAL_TYPES = ['Julia Set', 'Mandelbrot', 'Burning Ship', 'Kaleidoscope'];

    // ============================================
    // ARTIST PACKS
    // All artist-specific data lives here. When the
    // user picks an artist, switchArtist() swaps the
    // active data arrays so the entire app re-skins.
    // ============================================
    let activeArtist = 'chappell'; // default

    const ARTISTS = {
      chappell: {
        title: 'Pink Pony<br>Fractals',
        subtitle: 'a mic-reactive fractal visualizer',
        appTitle: '‚ú¶ Pink Pony Fractals',
        scoreLabel: 'Midwest Princess Rating',
        themeNames: ['Pink Pony Club', 'Red Wine Supernova', 'Midwest Princess', 'Good Luck, Babe!', 'Femininomenon', 'Naked in Manhattan'],
        themeClasses: ['', 'theme-redwine', 'theme-midwest', 'theme-goodluck', 'theme-femininomenon', 'theme-naked'],
        palettes: [
          [[10,0,7],[139,0,53],[255,45,107],[255,105,180],[255,215,0],[255,240,245]],
          [[10,0,3],[100,0,15],[220,20,60],[255,99,71],[255,193,7],[255,255,220]],
          [[16,0,43],[80,20,120],[199,125,255],[224,170,255],[128,255,219],[248,240,255]],
          [[10,5,5],[32,100,100],[255,107,107],[255,160,122],[32,178,170],[255,220,200]],
          [[0,5,14],[0,40,80],[0,212,255],[0,229,255],[255,0,170],[200,240,255]],
          [[14,10,0],[100,60,0],[232,163,23],[240,199,94],[255,140,105],[255,252,240]],
        ],
      },
      sabrina: {
        title: 'Short n\' Sweet<br>Fractals',
        subtitle: 'a mic-reactive fractal visualizer',
        appTitle: '‚ú¶ Short n\' Sweet Fractals',
        scoreLabel: 'Short n\' Sweet Rating',
        themeNames: ['Espresso', 'Please Please Please', 'Taste', 'Nonsense', 'Feather', 'Short n\' Sweet'],
        themeClasses: ['theme-espresso', 'theme-pleasepleasepl', 'theme-taste', 'theme-nonsense', 'theme-feather', 'theme-shortnsw'],
        palettes: [
          // Espresso ‚Äî coffee browns, cream, caramel
          [[14,8,4],[80,50,20],[196,138,63],[218,160,109],[240,213,168],[255,245,225]],
          // Please Please Please ‚Äî vintage blush, rose gold
          [[26,8,8],[130,50,55],[232,131,138],[244,180,184],[201,169,110],[253,222,222]],
          // Taste ‚Äî bold cherry red, cream, dramatic
          [[24,0,8],[100,0,25],[204,0,51],[255,51,85],[255,136,153],[255,230,204]],
          // Nonsense ‚Äî playful lavender, bubblegum, sparkle
          [[15,0,32],[70,20,120],[179,102,255],[255,133,200],[102,255,204],[255,190,230]],
          // Feather ‚Äî airy sky blue, white, soft gold
          [[4,14,20],[30,70,90],[91,168,200],[142,209,224],[240,208,128],[240,250,255]],
          // Short n' Sweet ‚Äî golden blonde, peach, warm
          [[20,16,0],[100,70,10],[224,168,48],[245,201,106],[255,158,128],[255,253,245]],
        ],
      },
    };

    // These "active" variables get swapped by switchArtist().
    // The rest of the app reads these, so nothing else needs to change.
    let THEME_NAMES = ARTISTS.chappell.themeNames;
    let THEME_CLASSES = ARTISTS.chappell.themeClasses;
    let PALETTES = ARTISTS.chappell.palettes;

    // Switch the active artist ‚Äî swaps all data arrays
    // and resets the UI to reflect the new artist
    function switchArtist(artistKey) {
      const artist = ARTISTS[artistKey];
      if (!artist) return;
      activeArtist = artistKey;

      // Swap all the active data arrays
      THEME_NAMES = artist.themeNames;
      THEME_CLASSES = artist.themeClasses;
      PALETTES = artist.palettes;
      DEFAULT_QUOTES = artist.defaultQuotes;
      CAMERA_FILTERS = artist.cameraFilters;
      TRIVIA_QUESTIONS = artist.triviaQuestions;
      TRIVIA_RESULTS = artist.triviaResults;

      // Reset indices to 0 so we don't overflow into non-existent themes
      state.paletteIndex = 0;
      state.themeIndex = 0;
      state.cameraFilterIndex = 0;
      state.editorFilterIndex = 0;

      // Apply first theme's CSS class
      document.body.className = THEME_CLASSES[0];

      // Update UI text
      document.getElementById('appTitle').textContent = artist.appTitle;
      document.querySelector('.trivia-score-label').textContent = artist.scoreLabel;

      // Reload quotes for this artist (from localStorage or defaults)
      quotes = loadQuotes();

      // Update camera filter name display if visible
      document.getElementById('cameraFilterName').textContent =
        '‚ú¶ ' + CAMERA_FILTERS[0].name + ' ‚ú¶';
      document.getElementById('editorFilterName').textContent =
        '‚ú¶ ' + CAMERA_FILTERS[0].name + ' ‚ú¶';

      updateInfoText();
    }

    // ============================================
    // FRACTAL CANVAS ‚Äî low-res for performance
    // ============================================
    const canvas = document.getElementById('fractalCanvas');
    const ctx = canvas.getContext('2d');
    let imgData, pixels;
    const RENDER_SCALE = 0.4; // 40% of screen res ‚Äî balance of smooth visuals + mobile performance

    function resizeCanvas() {
      canvas.width = Math.floor(window.innerWidth * RENDER_SCALE);
      canvas.height = Math.floor(window.innerHeight * RENDER_SCALE);
      imgData = ctx.createImageData(canvas.width, canvas.height);
      pixels = imgData.data;
      sparkleCanvas.width = window.innerWidth;
      sparkleCanvas.height = window.innerHeight;
    }

    // ============================================
    // SPARKLE OVERLAY
    // Floating glitter that reacts to audio.
    // Bass hits make them jitter; volume controls
    // brightness. Theme colors are read from CSS
    // vars so they auto-update on theme switch.
    // ============================================
    const sparkleCanvas = document.getElementById('sparkleCanvas');
    const sparkleCtx = sparkleCanvas.getContext('2d');
    const MAX_SPARKLES = 60;
    const sparkles = [];

    function createSparkle() {
      return {
        x: Math.random() * (sparkleCanvas.width || window.innerWidth),
        y: Math.random() * (sparkleCanvas.height || window.innerHeight),
        vx: (Math.random() - 0.5) * 0.5,
        vy: -Math.random() * 0.8 - 0.2,
        size: Math.random() * 2.5 + 0.5,
        opacity: Math.random(),
        phase: Math.random() * Math.PI * 2,
        speed: Math.random() * 2 + 1,
      };
    }

    for (let i = 0; i < MAX_SPARKLES; i++) sparkles.push(createSparkle());

    function renderSparkles() {
      const w = sparkleCanvas.width;
      const h = sparkleCanvas.height;
      sparkleCtx.clearRect(0, 0, w, h);

      // Read live CSS vars for theme-aware sparkle colors
      const style = getComputedStyle(document.body);
      const primaryColor = style.getPropertyValue('--primary').trim();
      const highlightColor = style.getPropertyValue('--highlight').trim();
      const audioBrightness = 0.3 + state.audioLevel * state.sensitivity * 0.7;

      for (const s of sparkles) {
        const audioKick = state.bassLevel * state.sensitivity * 2;
        s.x += s.vx + (Math.random() - 0.5) * audioKick;
        s.y += s.vy - audioKick * 0.5;
        s.phase += 0.03 * s.speed;

        // Wrap around edges
        if (s.y < -10) { s.y = h + 10; s.x = Math.random() * w; }
        if (s.x < -10) s.x = w + 10;
        if (s.x > w + 10) s.x = -10;

        const twinkle = (Math.sin(s.phase) + 1) / 2;
        const alpha = twinkle * audioBrightness * s.opacity;
        const color = s.phase % 6 < 3 ? primaryColor : highlightColor;

        // Core sparkle
        sparkleCtx.beginPath();
        sparkleCtx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
        sparkleCtx.fillStyle = color;
        sparkleCtx.globalAlpha = alpha;
        sparkleCtx.fill();

        // Soft glow halo
        sparkleCtx.beginPath();
        sparkleCtx.arc(s.x, s.y, s.size * 3, 0, Math.PI * 2);
        sparkleCtx.globalAlpha = alpha * 0.15;
        sparkleCtx.fill();
      }
      sparkleCtx.globalAlpha = 1;
    }

    // ============================================
    // COLOR PALETTES ‚Äî reads from active PALETTES variable
    // which is set by switchArtist()
    // ============================================

    function getColor(t, palIdx) {
      const pal = PALETTES[palIdx % PALETTES.length];
      const pos = t * (pal.length - 1);
      const idx = Math.floor(pos);
      const frac = pos - idx;
      const c1 = pal[Math.min(idx, pal.length - 1)];
      const c2 = pal[Math.min(idx + 1, pal.length - 1)];
      return [
        c1[0] + (c2[0] - c1[0]) * frac,
        c1[1] + (c2[1] - c1[1]) * frac,
        c1[2] + (c2[2] - c1[2]) * frac,
      ];
    }

    // ============================================
    // FRACTAL MATH
    // ============================================
    function juliaSet(zr, zi, cr, ci, maxIter) {
      let r = zr, i = zi;
      for (let n = 0; n < maxIter; n++) {
        const r2 = r * r, i2 = i * i;
        if (r2 + i2 > 4) return n / maxIter;
        i = 2 * r * i + ci;
        r = r2 - i2 + cr;
      }
      return 0;
    }

    function mandelbrot(cr, ci, maxIter) {
      let r = 0, i = 0;
      for (let n = 0; n < maxIter; n++) {
        const r2 = r * r, i2 = i * i;
        if (r2 + i2 > 4) return n / maxIter;
        i = 2 * r * i + ci;
        r = r2 - i2 + cr;
      }
      return 0;
    }

    function burningShip(cr, ci, maxIter) {
      let r = 0, i = 0;
      for (let n = 0; n < maxIter; n++) {
        const r2 = r * r, i2 = i * i;
        if (r2 + i2 > 4) return n / maxIter;
        i = Math.abs(2 * r * i) + ci;
        r = r2 - i2 + cr;
      }
      return 0;
    }

    // Kaleidoscope: mirrors the complex plane into
    // repeating wedge segments (like a real kaleidoscope),
    // then runs a Julia set on the folded coordinates.
    // The "segments" parameter controls how many mirror
    // slices ‚Äî audio modulates this for trippy shifts.
    function kaleidoscope(real, imag, cr, ci, maxIter, segments, rotation) {
      // Convert cartesian to polar coordinates
      // atan2 gives the angle, hypot gives the distance from center
      let angle = Math.atan2(imag, real) + rotation;
      let radius = Math.hypot(real, imag);

      // Fold the full circle into repeating wedge segments
      // This is the core kaleidoscope trick:
      // 1. Divide the circle into N segments
      // 2. Use modulo to wrap angle into one segment
      // 3. Mirror alternate segments by reflecting the angle
      const segAngle = (Math.PI * 2) / segments;
      angle = ((angle % segAngle) + segAngle) % segAngle; // Wrap to one segment
      if (angle > segAngle / 2) angle = segAngle - angle; // Mirror fold

      // Convert back to cartesian with the folded angle
      const zr = radius * Math.cos(angle);
      const zi = radius * Math.sin(angle);

      // Run Julia set on the folded coordinates
      // This gives us fractal detail inside the kaleidoscope pattern
      return juliaSet(zr, zi, cr, ci, maxIter);
    }

    // ============================================
    // RENDER LOOP ‚Äî runs every frame
    // ============================================
    function render() {
      state.time += 0.008;
      const w = canvas.width;
      const h = canvas.height;

      // Update audio
      if (state.micActive && state.analyser) {
        updateAudioLevels();
      } else {
        state.audioLevel = 0.15 + 0.1 * Math.sin(state.time * 0.7);
        state.bassLevel = 0.2 + 0.15 * Math.sin(state.time * 0.3);
        state.trebleLevel = 0.1 + 0.1 * Math.sin(state.time * 1.1);
      }

      const sens = state.sensitivity;
      const audio = state.audioLevel * sens;
      const bass = state.bassLevel * sens;
      const treble = state.trebleLevel * sens;

      // Audio meter bar
      const meterWidth = Math.min(state.audioLevel * sens * 150, 100);
      document.getElementById('audioMeter').style.width = meterWidth + '%';

      // Fractal parameters modulated by audio
      const maxIter = Math.floor(40 + bass * 60);
      const cr = -0.7 + 0.3 * Math.sin(state.time + bass * 2);
      const ci = 0.27 + 0.15 * Math.cos(state.time * 0.7 + treble * 3);
      const zoom = 2.5 - audio * 0.8;
      const panX = 0.1 * Math.sin(state.time * 0.2) * (1 + bass);
      const panY = 0.1 * Math.cos(state.time * 0.15) * (1 + treble);
      const aspect = w / h;

      // Compute every pixel
      for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
          const real = ((x / w - 0.5) * aspect) * zoom + panX;
          const imag = ((y / h - 0.5)) * zoom + panY;

          let val;
          switch (state.fractalType) {
            case 0: val = juliaSet(real, imag, cr, ci, maxIter); break;
            case 1: val = mandelbrot(real, imag, maxIter); break;
            case 2: val = burningShip(real, imag + 0.5, maxIter); break;
            case 3:
              // Kaleidoscope: bass controls segment count (6-12 slices),
              // time + treble drives rotation speed for that spinning effect
              const segments = Math.floor(6 + bass * 6);
              const rotation = state.time * 0.4 + treble * 2;
              val = kaleidoscope(real, imag, cr, ci, maxIter, segments, rotation);
              break;
          }

          const colorShift = audio * 0.3;
          const t = (val + colorShift) % 1;
          const [r, g, b] = getColor(t, state.paletteIndex);

          const idx = (y * w + x) * 4;
          pixels[idx] = r;
          pixels[idx + 1] = g;
          pixels[idx + 2] = b;
          pixels[idx + 3] = 255;
        }
      }

      ctx.putImageData(imgData, 0, 0);
      renderSparkles();
      state.animFrame = requestAnimationFrame(render);
    }

    // ============================================
    // AUDIO ANALYSIS ‚Äî FFT frequency extraction
    // ============================================
    function updateAudioLevels() {
      const bufferLength = state.analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      state.analyser.getByteFrequencyData(dataArray);

      let sum = 0, bassSum = 0, trebleSum = 0;
      const bassEnd = Math.floor(bufferLength * 0.15);
      const trebleStart = Math.floor(bufferLength * 0.5);

      for (let i = 0; i < bufferLength; i++) {
        const val = dataArray[i] / 255;
        sum += val;
        if (i < bassEnd) bassSum += val;
        if (i > trebleStart) trebleSum += val;
      }

      const smoothing = 0.15;
      state.audioLevel = lerp(state.audioLevel, sum / bufferLength, smoothing);
      state.bassLevel = lerp(state.bassLevel, bassSum / bassEnd, smoothing);
      state.trebleLevel = lerp(state.trebleLevel, trebleSum / (bufferLength - trebleStart), smoothing);
    }

    function lerp(a, b, t) { return a + (b - a) * t; }

    // ============================================
    // MIC CONTROL
    // ============================================
    async function enableMic() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }
        });
        state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        state.analyser = state.audioContext.createAnalyser();
        state.analyser.fftSize = 512;
        state.analyser.smoothingTimeConstant = 0.8;
        const source = state.audioContext.createMediaStreamSource(stream);
        source.connect(state.analyser);
        state.micStream = stream;
        state.micActive = true;
        updateMicUI(true);
      } catch (err) {
        console.error('Mic access denied:', err);
        alert('Mic access needed for audio reactivity. Auto-animation mode active!');
      }
    }

    function disableMic() {
      if (state.micStream) state.micStream.getTracks().forEach(t => t.stop());
      if (state.audioContext) state.audioContext.close();
      state.micActive = false;
      state.audioContext = null;
      state.analyser = null;
      state.micStream = null;
      updateMicUI(false);
    }

    function updateMicUI(active) {
      const dot = document.getElementById('micDot');
      const label = document.getElementById('micLabel');
      const btn = document.getElementById('btnMic');
      if (active) {
        dot.classList.remove('inactive');
        label.textContent = 'mic live';
        btn.classList.add('active');
        btn.innerHTML = '<span class="btn-icon">‚èπ</span> Mic';
      } else {
        dot.classList.add('inactive');
        label.textContent = 'mic off';
        btn.classList.remove('active');
        btn.innerHTML = '<span class="btn-icon">‚è∫</span> Mic';
        document.getElementById('audioMeter').style.width = '0%';
      }
    }

    // ============================================
    // THEME SWITCHING ‚Äî now split into two controls
    //
    // UI Theme: changes buttons, text, badges, meter
    //   bar ‚Äî everything in the CSS custom properties.
    // Fractal Colors: changes the palette used to
    //   color fractal pixels + sparkle particles.
    // They cycle independently so you can mix & match.
    // ============================================
    function cycleUITheme() {
      state.themeIndex = (state.themeIndex + 1) % THEME_NAMES.length;
      // Swap the CSS class on body ‚Äî all CSS vars update instantly
      document.body.className = THEME_CLASSES[state.themeIndex];
      updateInfoText();
    }

    function cycleFractalColors() {
      state.paletteIndex = (state.paletteIndex + 1) % THEME_NAMES.length;
      updateInfoText();
    }

    function updateInfoText() {
      const mode = state.quoteMode ? 'Quote Mode' : FRACTAL_TYPES[state.fractalType];
      // Show both the fractal color name and UI theme name
      // so user knows what's selected for each
      const colorName = THEME_NAMES[state.paletteIndex];
      const uiName = THEME_NAMES[state.themeIndex];
      if (colorName === uiName) {
        // Same theme for both ‚Äî show it once to keep it clean
        document.getElementById('fractalInfo').textContent =
          '‚ú¶ ' + mode + ' ¬∑ ' + colorName + ' ‚ú¶';
      } else {
        document.getElementById('fractalInfo').textContent =
          '‚ú¶ ' + mode + ' ¬∑ ' + colorName + ' ¬∑ ' + uiName + ' UI ‚ú¶';
      }
    }

    // ============================================
    // FULLSCREEN TOGGLE
    // ============================================
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(() => {});
      } else {
        document.exitFullscreen();
      }
    }

    // ============================================
    // TAP TO HIDE UI ‚Äî immersive mode
    // ============================================
    function toggleUI() {
      state.uiVisible = !state.uiVisible;
      document.getElementById('topBar').classList.toggle('ui-hidden', !state.uiVisible);
      document.getElementById('bottomBar').classList.toggle('ui-hidden', !state.uiVisible);
    }

    // ============================================
    // QUOTE SYSTEM
    // Inspirational themes/sentiments ‚Äî per artist.
    // Users can add their own favorites via the
    // Edit modal ‚Äî those persist in localStorage
    // (separate key per artist).
    // ============================================

    // Default quotes per artist are stored in the ARTISTS config
    // and the active set is in DEFAULT_QUOTES (swapped by switchArtist)

    // --- Add default quotes to artist configs ---
    ARTISTS.chappell.defaultQuotes = [
      { text: "You deserve a love that feels like dancing under neon lights", source: "on finding joy" },
      { text: "Set your boundaries like they're made of glitter and steel", source: "on self-worth" },
      { text: "The midwest made you, but it doesn't get to keep you small", source: "on growing" },
      { text: "Be the kind of bold that makes the whole room nervous", source: "on confidence" },
      { text: "Sometimes the bravest thing is letting yourself want more", source: "on courage" },
      { text: "Your softness is not weakness ‚Äî it's your superpower", source: "on vulnerability" },
      { text: "Burn so bright they need sunglasses just to look at you", source: "on being unapologetic" },
      { text: "Home is wherever you stop apologizing for who you are", source: "on belonging" },
      { text: "Love yourself the way you love your favorite song ‚Äî loud and on repeat", source: "on self-love" },
      { text: "You are not too much. They were just not enough.", source: "on knowing your worth" },
      { text: "Some fires aren't meant to be put out", source: "on passion" },
      { text: "The right people won't ask you to dim your sparkle", source: "on chosen family" },
    ];

    ARTISTS.sabrina.defaultQuotes = [
      { text: "That's that me espresso ‚Äî know your worth and let them come to you", source: "on confidence" },
      { text: "Short and sweet doesn't mean forgettable ‚Äî it means unforgettable", source: "on impact" },
      { text: "The best revenge is becoming exactly who they said you couldn't be", source: "on growth" },
      { text: "You're allowed to outgrow the version of yourself they fell in love with", source: "on evolution" },
      { text: "Be the kind of woman who makes the whole room rethink their choices", source: "on self-assurance" },
      { text: "Nonsense is underrated ‚Äî sometimes joy doesn't need to make sense", source: "on living freely" },
      { text: "You can be soft and still be the most powerful person in the room", source: "on duality" },
      { text: "Some chapters end so better ones can begin", source: "on moving on" },
      { text: "The things that make you different are the things that make you shine", source: "on being yourself" },
      { text: "Please, please, please ‚Äî never settle for less than butterflies", source: "on love" },
      { text: "Your taste in who deserves you should be impeccable", source: "on standards" },
      { text: "Light as a feather, strong as a storm", source: "on resilience" },
    ];

    let DEFAULT_QUOTES = ARTISTS.chappell.defaultQuotes;

    // Load custom quotes from localStorage, fall back to defaults
    // Uses artist-specific keys so each artist has separate custom quotes
    function loadQuotes() {
      try {
        const key = 'quotes_' + activeArtist;
        const saved = localStorage.getItem(key);
        if (saved) {
          const parsed = JSON.parse(saved);
          if (Array.isArray(parsed) && parsed.length > 0) return parsed;
        }
      } catch (e) {
        console.warn('Could not load saved quotes:', e);
      }
      return [...DEFAULT_QUOTES];
    }

    function saveQuotes(quotes) {
      try {
        const key = 'quotes_' + activeArtist;
        localStorage.setItem(key, JSON.stringify(quotes));
      } catch (e) {
        console.warn('Could not save quotes:', e);
      }
    }

    let quotes = loadQuotes();

    // Show a specific quote with fade animation
    function showQuote(index) {
      const overlay = document.getElementById('quoteOverlay');
      const textEl = document.getElementById('quoteText');
      const sourceEl = document.getElementById('quoteSource');

      if (quotes.length === 0) {
        textEl.textContent = 'Add your favorite quotes ‚ú¶';
        sourceEl.textContent = 'tap edit to begin';
        return;
      }

      const q = quotes[index % quotes.length];
      // Force re-trigger of the CSS fade animation by
      // briefly removing and re-adding the element content
      textEl.style.animation = 'none';
      textEl.offsetHeight; // Trigger reflow (forces browser to reset)
      textEl.style.animation = '';
      textEl.textContent = q.text;
      sourceEl.textContent = '‚Äî ' + q.source;
    }

    // Cycle to next quote
    function nextQuote() {
      state.quoteIndex = (state.quoteIndex + 1) % Math.max(quotes.length, 1);
      showQuote(state.quoteIndex);
    }

    // Toggle quote mode on/off
    function toggleQuoteMode() {
      state.quoteMode = !state.quoteMode;
      const overlay = document.getElementById('quoteOverlay');
      const btn = document.getElementById('btnQuotes');

      if (state.quoteMode) {
        // Enter quote mode: disable mic, show quotes
        if (state.micActive) disableMic();
        overlay.classList.add('visible');
        btn.classList.add('active');
        showQuote(state.quoteIndex);
        // Auto-cycle quotes every 8 seconds
        state.quoteTimer = setInterval(nextQuote, 8000);
      } else {
        // Exit quote mode
        overlay.classList.remove('visible');
        btn.classList.remove('active');
        clearInterval(state.quoteTimer);
        state.quoteTimer = null;
      }

      updateInfoText();
    }

    // ============================================
    // QUOTE MODAL ‚Äî add/remove custom quotes
    // ============================================
    function openQuoteModal() {
      document.getElementById('quoteModal').classList.add('visible');
      renderQuoteList();
    }

    function closeQuoteModal() {
      document.getElementById('quoteModal').classList.remove('visible');
    }

    function renderQuoteList() {
      const list = document.getElementById('quoteList');
      list.innerHTML = '';

      quotes.forEach((q, i) => {
        const item = document.createElement('div');
        item.className = 'quote-item';
        item.innerHTML = `
          <div class="quote-item-text">
            "${q.text}"
            <div class="quote-item-source">${q.source}</div>
          </div>
          <button class="quote-delete" data-index="${i}">√ó</button>
        `;
        list.appendChild(item);
      });

      // Attach delete handlers
      list.querySelectorAll('.quote-delete').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.index);
          quotes.splice(idx, 1);
          saveQuotes(quotes);
          renderQuoteList();
          // If we deleted the current quote, reset index
          if (state.quoteIndex >= quotes.length) state.quoteIndex = 0;
          if (state.quoteMode) showQuote(state.quoteIndex);
        });
      });
    }

    function addCustomQuote() {
      const input = document.getElementById('newQuoteInput');
      const text = input.value.trim();
      if (!text) return;

      // Add with a default source ‚Äî user can just type the quote
      quotes.push({ text: text, source: 'custom' });
      saveQuotes(quotes);
      input.value = '';
      renderQuoteList();
    }

    // ============================================
    // CAMERA SYSTEM
    // Opens the device camera, draws each frame to
    // a canvas, and applies pixel-level color filters
    // matching each Chappell Roan theme.
    //
    // Filter math per pixel:
    // 1. Convert RGB to HSL for saturation control
    // 2. Apply tint (shift R/G/B channels)
    // 3. Apply contrast curve
    // 4. Apply vignette (darken edges)
    // ============================================

    const cameraVideo = document.getElementById('cameraVideo');
    const cameraCanvas = document.getElementById('cameraCanvas');
    const cameraCtx = cameraCanvas.getContext('2d', { willReadFrequently: true });

    // Filter presets ‚Äî each defines how to transform colors
    // tint: [r, g, b] multipliers (1.0 = unchanged)
    // saturation: multiplier (1.0 = unchanged, 1.5 = boosted)
    // contrast: multiplier (1.0 = unchanged)
    // warmth: shifts color temperature (positive = warm, negative = cool)
    // vignette: strength of edge darkening (0 = none, 1 = strong)
    // Camera filters per artist ‚Äî stored in ARTISTS config
    ARTISTS.chappell.cameraFilters = [
      { name: 'Pink Pony Club', tint: [1.15, 0.9, 1.0], saturation: 1.4, contrast: 1.1, warmth: 15, vignette: 0.3 },
      { name: 'Red Wine Supernova', tint: [1.25, 0.85, 0.8], saturation: 1.3, contrast: 1.25, warmth: 25, vignette: 0.45 },
      { name: 'Midwest Princess', tint: [1.05, 0.95, 1.1], saturation: 0.85, contrast: 0.95, warmth: -5, vignette: 0.2 },
      { name: 'Good Luck, Babe!', tint: [1.2, 0.95, 0.9], saturation: 1.3, contrast: 1.1, warmth: 20, vignette: 0.25 },
      { name: 'Femininomenon', tint: [0.85, 1.05, 1.2], saturation: 1.45, contrast: 1.2, warmth: -20, vignette: 0.35 },
      { name: 'Naked in Manhattan', tint: [1.2, 1.05, 0.85], saturation: 1.15, contrast: 1.05, warmth: 30, vignette: 0.2 },
    ];

    ARTISTS.sabrina.cameraFilters = [
      { name: 'Espresso', tint: [1.2, 1.0, 0.85], saturation: 1.15, contrast: 1.15, warmth: 25, vignette: 0.3 },
      { name: 'Please Please Please', tint: [1.12, 0.95, 0.98], saturation: 1.1, contrast: 1.0, warmth: 12, vignette: 0.2 },
      { name: 'Taste', tint: [1.2, 0.85, 0.85], saturation: 1.35, contrast: 1.3, warmth: 10, vignette: 0.45 },
      { name: 'Nonsense', tint: [1.0, 0.92, 1.15], saturation: 1.4, contrast: 1.1, warmth: -8, vignette: 0.25 },
      { name: 'Feather', tint: [0.9, 1.05, 1.15], saturation: 0.9, contrast: 0.95, warmth: -10, vignette: 0.15 },
      { name: 'Short n\' Sweet', tint: [1.15, 1.05, 0.9], saturation: 1.2, contrast: 1.05, warmth: 20, vignette: 0.2 },
    ];

    let CAMERA_FILTERS = ARTISTS.chappell.cameraFilters;

    async function openCamera() {
      try {
        // Stop mic if active ‚Äî most mobile devices can't do both
        if (state.micActive) disableMic();
        if (state.quoteMode) toggleQuoteMode();

        // Request camera access
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: state.facingMode,
            width: { ideal: 1280 },
            height: { ideal: 720 },
          },
          audio: false,
        });

        cameraVideo.srcObject = stream;
        state.cameraStream = stream;

        // Explicitly call play() ‚Äî mobile browsers ignore the
        // autoplay attribute even on muted video elements.
        // This is the most common reason for a black camera canvas.
        await cameraVideo.play();

        // Wait for actual video frames to be available.
        // readyState 2+ means at least one frame is decoded.
        // Without this, drawImage pulls a blank black frame.
        await new Promise((resolve) => {
          if (cameraVideo.readyState >= 2) {
            resolve();
          } else {
            cameraVideo.addEventListener('loadeddata', resolve, { once: true });
          }
        });

        // Size canvas smaller than screen for performance.
        // Processing every pixel per frame is expensive ‚Äî
        // 60% res keeps filters smooth while running well on mobile.
        // CSS scales it up smoothly (same trick as the fractal canvas).
        const CAM_SCALE = 0.6;
        cameraCanvas.width = Math.floor(window.innerWidth * CAM_SCALE);
        cameraCanvas.height = Math.floor(window.innerHeight * CAM_SCALE);

        // Show camera UI, hide fractal UI
        state.cameraActive = true;
        document.getElementById('cameraLayer').classList.add('active');
        document.getElementById('cameraControls').classList.add('active');
        document.getElementById('topBar').classList.add('ui-hidden');
        document.getElementById('bottomBar').classList.add('ui-hidden');

        // Start camera render loop
        renderCamera();

      } catch (err) {
        console.error('Camera access denied:', err);
        alert('Camera access is needed for this feature.');
      }
    }

    function closeCamera() {
      // Stop all video tracks to release the camera
      if (state.cameraStream) {
        state.cameraStream.getTracks().forEach(t => t.stop());
        state.cameraStream = null;
      }
      cameraVideo.srcObject = null;

      // Cancel camera render loop
      if (state.cameraAnimFrame) {
        cancelAnimationFrame(state.cameraAnimFrame);
        state.cameraAnimFrame = null;
      }

      // Hide camera UI, restore fractal UI
      state.cameraActive = false;
      document.getElementById('cameraLayer').classList.remove('active');
      document.getElementById('cameraControls').classList.remove('active');
      if (state.uiVisible) {
        document.getElementById('topBar').classList.remove('ui-hidden');
        document.getElementById('bottomBar').classList.remove('ui-hidden');
      }
    }

    async function flipCamera() {
      // Toggle between front and back camera
      state.facingMode = state.facingMode === 'user' ? 'environment' : 'user';
      if (state.cameraActive) {
        // Fully close current camera first
        if (state.cameraStream) {
          state.cameraStream.getTracks().forEach(t => t.stop());
          state.cameraStream = null;
        }
        cameraVideo.srcObject = null;
        if (state.cameraAnimFrame) {
          cancelAnimationFrame(state.cameraAnimFrame);
          state.cameraAnimFrame = null;
        }
        // Hide camera layer during switch to avoid flash
        state.cameraActive = false;
        // Brief delay for camera hardware to fully release
        await new Promise(r => setTimeout(r, 300));
        // Re-open with flipped facing mode
        openCamera();
      }
    }

    function cycleCameraFilter() {
      state.cameraFilterIndex = (state.cameraFilterIndex + 1) % CAMERA_FILTERS.length;
      document.getElementById('cameraFilterName').textContent =
        '‚ú¶ ' + CAMERA_FILTERS[state.cameraFilterIndex].name + ' ‚ú¶';
    }

    // ============================================
    // CAMERA FRAMES & VIGNETTES
    // Decorative overlays drawn on top of the
    // filtered camera feed. Each frame uses canvas
    // 2D drawing for borders, corners, stars, and
    // text ‚Äî all in the Chappell Roan camp style.
    //
    // Index 0 = no frame, 1+ = frame styles
    // ============================================
    const CAMERA_FRAMES = [
      { name: 'None' },
      {
        name: 'Neon Marquee',
        // Double neon border with glowing corners ‚Äî like a motel sign
      },
      {
        name: 'Glitter Vignette',
        // Heavy dark vignette with sparkle stars scattered around edges
      },
      {
        name: 'Drag Pageant',
        // Ornate corner flourishes + crown element at top center
      },
      {
        name: 'Polaroid Dreamy',
        // Thick white border on bottom (like a polaroid), soft top edges
      },
      {
        name: 'Star Burst',
        // Radiating star pattern from corners with light leak effect
      },
      {
        name: 'County Fair',
        // Scalloped carnival-ticket edge border with warm glow
      },
    ];

    function cycleCameraFrame() {
      state.cameraFrameIndex = (state.cameraFrameIndex + 1) % CAMERA_FRAMES.length;
      const name = CAMERA_FRAMES[state.cameraFrameIndex].name;
      document.getElementById('cameraFrameName').textContent =
        state.cameraFrameIndex === 0 ? '' : '‚¨• ' + name;
    }

    // Draw a 5-pointed star at (x, y) with given size
    function drawStar(ctx, x, y, size, color, alpha) {
      ctx.save();
      ctx.globalAlpha = alpha;
      ctx.fillStyle = color;
      ctx.beginPath();
      for (let i = 0; i < 5; i++) {
        const angle = -Math.PI / 2 + (i * Math.PI * 2) / 5;
        const innerAngle = angle + Math.PI / 5;
        const outerR = size;
        const innerR = size * 0.4;
        if (i === 0) ctx.moveTo(x + outerR * Math.cos(angle), y + outerR * Math.sin(angle));
        else ctx.lineTo(x + outerR * Math.cos(angle), y + outerR * Math.sin(angle));
        ctx.lineTo(x + innerR * Math.cos(innerAngle), y + innerR * Math.sin(innerAngle));
      }
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    }

    // Draw a diamond/sparkle shape (4-pointed star)
    function drawSparkle(ctx, x, y, size, color, alpha) {
      ctx.save();
      ctx.globalAlpha = alpha;
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(x, y - size);
      ctx.lineTo(x + size * 0.3, y);
      ctx.lineTo(x, y + size);
      ctx.lineTo(x - size * 0.3, y);
      ctx.closePath();
      ctx.fill();
      // Cross sparkle (rotated)
      ctx.beginPath();
      ctx.moveTo(x - size, y);
      ctx.lineTo(x, y + size * 0.3);
      ctx.lineTo(x + size, y);
      ctx.lineTo(x, y - size * 0.3);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    }

    function drawCameraFrame(ctx, w, h) {
      const frameIdx = state.cameraFrameIndex;
      if (frameIdx === 0) return; // No frame selected

      // Read current theme colors for theme-aware frames
      const style = getComputedStyle(document.body);
      const primary = style.getPropertyValue('--primary').trim();
      const accent = style.getPropertyValue('--accent').trim();
      const highlight = style.getPropertyValue('--highlight').trim();
      const accentSoft = style.getPropertyValue('--accent-soft').trim();

      ctx.save();

      switch (frameIdx) {
        case 1: {
          // ---- NEON MARQUEE ----
          // Double neon border with glow ‚Äî like a motel sign
          const inset = w * 0.04;
          const innerInset = w * 0.06;

          // Outer glow
          ctx.shadowColor = primary;
          ctx.shadowBlur = 20;
          ctx.strokeStyle = primary;
          ctx.lineWidth = 3;
          ctx.strokeRect(inset, inset, w - inset * 2, h - inset * 2);

          // Inner line
          ctx.shadowBlur = 12;
          ctx.strokeStyle = accent;
          ctx.lineWidth = 1.5;
          ctx.strokeRect(innerInset, innerInset, w - innerInset * 2, h - innerInset * 2);
          ctx.shadowBlur = 0;

          // Corner dots (like marquee bulbs)
          const bulbR = w * 0.008;
          const corners = [
            [inset, inset], [w - inset, inset],
            [inset, h - inset], [w - inset, h - inset]
          ];
          corners.forEach(([cx, cy]) => {
            ctx.beginPath();
            ctx.arc(cx, cy, bulbR * 2, 0, Math.PI * 2);
            ctx.fillStyle = highlight;
            ctx.shadowColor = highlight;
            ctx.shadowBlur = 15;
            ctx.fill();
          });

          // Bulbs along edges
          ctx.shadowBlur = 8;
          const spacing = w * 0.06;
          for (let x = inset + spacing; x < w - inset; x += spacing) {
            ctx.beginPath();
            ctx.arc(x, inset, bulbR, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x, h - inset, bulbR, 0, Math.PI * 2);
            ctx.fill();
          }
          for (let y = inset + spacing; y < h - inset; y += spacing) {
            ctx.beginPath();
            ctx.arc(inset, y, bulbR, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(w - inset, y, bulbR, 0, Math.PI * 2);
            ctx.fill();
          }
          break;
        }

        case 2: {
          // ---- GLITTER VIGNETTE ----
          // Heavy dramatic vignette with scattered sparkles
          const vigGrad = ctx.createRadialGradient(
            w / 2, h / 2, w * 0.2,
            w / 2, h / 2, w * 0.7
          );
          vigGrad.addColorStop(0, 'rgba(0,0,0,0)');
          vigGrad.addColorStop(0.5, 'rgba(0,0,0,0.15)');
          vigGrad.addColorStop(0.8, 'rgba(0,0,0,0.5)');
          vigGrad.addColorStop(1, 'rgba(0,0,0,0.85)');
          ctx.fillStyle = vigGrad;
          ctx.fillRect(0, 0, w, h);

          // Scattered sparkles around the edges
          // Use a seeded-ish pattern so they don't jump every frame
          const sparkleCount = 30;
          for (let i = 0; i < sparkleCount; i++) {
            // Distribute around the edges using fixed pattern
            const angle = (i / sparkleCount) * Math.PI * 2;
            const edgeDist = 0.35 + (((i * 7) % 13) / 13) * 0.15;
            const sx = w / 2 + Math.cos(angle) * w * edgeDist;
            const sy = h / 2 + Math.sin(angle) * h * edgeDist;
            const size = w * 0.01 + (((i * 3) % 7) / 7) * w * 0.015;
            // Alternate between primary and highlight colors
            const col = i % 3 === 0 ? highlight : (i % 3 === 1 ? primary : accent);
            const alpha = 0.4 + (((i * 11) % 10) / 10) * 0.5;
            drawSparkle(ctx, sx, sy, size, col, alpha);
          }
          break;
        }

        case 3: {
          // ---- DRAG PAGEANT ----
          // Ornate corner flourishes + crown at top center
          const m = w * 0.05; // margin

          // Corner flourishes ‚Äî curved decorative lines
          ctx.strokeStyle = highlight;
          ctx.lineWidth = 2;
          ctx.shadowColor = highlight;
          ctx.shadowBlur = 8;
          const fLen = w * 0.12;

          // Draw L-shaped flourishes with curved ends at each corner
          [[m, m, 1, 1], [w - m, m, -1, 1], [m, h - m, 1, -1], [w - m, h - m, -1, -1]].forEach(([cx, cy, dx, dy]) => {
            ctx.beginPath();
            ctx.moveTo(cx, cy + dy * fLen);
            ctx.quadraticCurveTo(cx, cy, cx + dx * fLen * 0.3, cy);
            ctx.lineTo(cx + dx * fLen, cy);
            ctx.stroke();
            // Decorative dot at end
            ctx.beginPath();
            ctx.arc(cx + dx * fLen, cy, 3, 0, Math.PI * 2);
            ctx.fillStyle = highlight;
            ctx.fill();
            ctx.beginPath();
            ctx.arc(cx, cy + dy * fLen, 3, 0, Math.PI * 2);
            ctx.fill();
          });

          ctx.shadowBlur = 0;

          // Crown at top center
          const crownW = w * 0.15;
          const crownH = h * 0.05;
          const crownX = w / 2;
          const crownY = m + crownH * 0.5;

          ctx.strokeStyle = highlight;
          ctx.lineWidth = 2;
          ctx.shadowColor = highlight;
          ctx.shadowBlur = 10;
          ctx.beginPath();
          ctx.moveTo(crownX - crownW / 2, crownY + crownH / 2);
          ctx.lineTo(crownX - crownW / 2, crownY);
          ctx.lineTo(crownX - crownW / 4, crownY + crownH * 0.3);
          ctx.lineTo(crownX, crownY - crownH / 2);
          ctx.lineTo(crownX + crownW / 4, crownY + crownH * 0.3);
          ctx.lineTo(crownX + crownW / 2, crownY);
          ctx.lineTo(crownX + crownW / 2, crownY + crownH / 2);
          ctx.stroke();

          // Crown jewels (dots at tips)
          [crownX - crownW / 2, crownX - crownW / 4, crownX, crownX + crownW / 4, crownX + crownW / 2].forEach((jx, ji) => {
            const jy = ji === 2 ? crownY - crownH / 2 : (ji % 2 === 0 ? crownY : crownY + crownH * 0.3);
            ctx.beginPath();
            ctx.arc(jx, jy, 4, 0, Math.PI * 2);
            ctx.fillStyle = ji === 2 ? primary : highlight;
            ctx.fill();
          });

          // Stars flanking crown
          drawStar(ctx, crownX - crownW * 0.8, crownY, w * 0.015, accent, 0.7);
          drawStar(ctx, crownX + crownW * 0.8, crownY, w * 0.015, accent, 0.7);
          break;
        }

        case 4: {
          // ---- POLAROID DREAMY ----
          // Thick white bottom border, thin top/sides, soft vignette
          const borderSide = w * 0.03;
          const borderTop = w * 0.03;
          const borderBottom = h * 0.12;

          // White border (slightly warm tinted)
          ctx.fillStyle = '#faf5ef';
          // Top
          ctx.fillRect(0, 0, w, borderTop);
          // Bottom
          ctx.fillRect(0, h - borderBottom, w, borderBottom);
          // Left
          ctx.fillRect(0, 0, borderSide, h);
          // Right
          ctx.fillRect(w - borderSide, 0, borderSide, h);

          // Soft inner shadow along border edges
          const innerGlow = ctx.createRadialGradient(
            w / 2, h * 0.45, w * 0.25,
            w / 2, h * 0.45, w * 0.55
          );
          innerGlow.addColorStop(0, 'rgba(0,0,0,0)');
          innerGlow.addColorStop(1, 'rgba(0,0,0,0.12)');
          ctx.fillStyle = innerGlow;
          ctx.fillRect(borderSide, borderTop, w - borderSide * 2, h - borderTop - borderBottom);

          // Small star in bottom border area
          const starY = h - borderBottom / 2;
          drawSparkle(ctx, w / 2, starY, w * 0.015, primary, 0.5);

          break;
        }

        case 5: {
          // ---- STAR BURST ----
          // Radiating stars from corners with light leak gradient
          // Light leak overlays from corners
          const leakGrad1 = ctx.createRadialGradient(0, 0, 0, 0, 0, w * 0.5);
          leakGrad1.addColorStop(0, primary.replace(')', ',0.2)').replace('rgb', 'rgba'));
          leakGrad1.addColorStop(0.5, 'rgba(255,0,0,0)');
          ctx.fillStyle = leakGrad1;
          ctx.fillRect(0, 0, w, h);

          const leakGrad2 = ctx.createRadialGradient(w, h, 0, w, h, w * 0.5);
          leakGrad2.addColorStop(0, highlight.replace(')', ',0.15)').replace('rgb', 'rgba'));
          leakGrad2.addColorStop(0.5, 'rgba(255,0,0,0)');
          ctx.fillStyle = leakGrad2;
          ctx.fillRect(0, 0, w, h);

          // Stars radiating from corners
          const starPositions = [
            // Top-left cluster
            [w * 0.06, h * 0.06, 0.025], [w * 0.12, h * 0.04, 0.015], [w * 0.04, h * 0.13, 0.018],
            // Top-right cluster
            [w * 0.94, h * 0.06, 0.025], [w * 0.88, h * 0.04, 0.015], [w * 0.96, h * 0.13, 0.018],
            // Bottom-left cluster
            [w * 0.06, h * 0.94, 0.02], [w * 0.12, h * 0.96, 0.012], [w * 0.04, h * 0.87, 0.015],
            // Bottom-right cluster
            [w * 0.94, h * 0.94, 0.02], [w * 0.88, h * 0.96, 0.012], [w * 0.96, h * 0.87, 0.015],
            // Scattered mid-edges
            [w * 0.5, h * 0.03, 0.012], [w * 0.5, h * 0.97, 0.012],
            [w * 0.03, h * 0.5, 0.012], [w * 0.97, h * 0.5, 0.012],
          ];

          starPositions.forEach(([sx, sy, sizeRatio], i) => {
            const col = i % 3 === 0 ? highlight : (i % 3 === 1 ? accent : primary);
            drawStar(ctx, sx, sy, w * sizeRatio, col, 0.6 + (i % 3) * 0.15);
          });
          break;
        }

        case 6: {
          // ---- COUNTY FAIR ----
          // Scalloped carnival-ticket edge with warm inner glow
          const scallop = w * 0.025;
          const border = w * 0.03;

          // Warm border glow
          ctx.fillStyle = 'rgba(0,0,0,0.4)';
          ctx.fillRect(0, 0, w, border);
          ctx.fillRect(0, h - border, w, border);
          ctx.fillRect(0, 0, border, h);
          ctx.fillRect(w - border, 0, border, h);

          // Scalloped edge ‚Äî punch semicircular notches along border
          // This creates the carnival ticket / county fair ribbon look
          ctx.globalCompositeOperation = 'destination-out';
          const scSpacing = scallop * 2.5;

          // Top and bottom scallops
          for (let x = scSpacing; x < w - scSpacing / 2; x += scSpacing) {
            ctx.beginPath();
            ctx.arc(x, 0, scallop, 0, Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x, h, scallop, Math.PI, Math.PI * 2);
            ctx.fill();
          }
          // Left and right scallops
          for (let y = scSpacing; y < h - scSpacing / 2; y += scSpacing) {
            ctx.beginPath();
            ctx.arc(0, y, scallop, -Math.PI / 2, Math.PI / 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(w, y, scallop, Math.PI / 2, Math.PI * 1.5);
            ctx.fill();
          }
          ctx.globalCompositeOperation = 'source-over';

          // Inner neon line following the scallop
          ctx.strokeStyle = primary;
          ctx.lineWidth = 1.5;
          ctx.shadowColor = primary;
          ctx.shadowBlur = 10;
          const inset = border + scallop * 0.5;
          ctx.strokeRect(inset, inset, w - inset * 2, h - inset * 2);
          ctx.shadowBlur = 0;

          // Small decorative stars at corners inside border
          const ci = border * 1.8;
          drawStar(ctx, ci, ci, w * 0.012, highlight, 0.8);
          drawStar(ctx, w - ci, ci, w * 0.012, highlight, 0.8);
          drawStar(ctx, ci, h - ci, w * 0.012, highlight, 0.8);
          drawStar(ctx, w - ci, h - ci, w * 0.012, highlight, 0.8);
          break;
        }
      }

      ctx.restore();
    }

    // ============================================
    // CAMERA RENDER LOOP
    // Each frame: draw video to canvas, read pixels,
    // apply color filter math, write pixels back.
    // ============================================
    function renderCamera() {
      if (!state.cameraActive) return;

      const w = cameraCanvas.width;
      const h = cameraCanvas.height;

      // Skip frame if video isn't ready yet (prevents black frames
      // during camera switches or brief stalls)
      if (cameraVideo.readyState < 2) {
        state.cameraAnimFrame = requestAnimationFrame(renderCamera);
        return;
      }

      // Draw current video frame to canvas using "cover" fit.
      // This scales the video to fill the entire canvas,
      // cropping the excess rather than letterboxing.
      // Same logic as CSS object-fit:cover but done manually
      // because canvas doesn't support that CSS property.
      const vw = cameraVideo.videoWidth;
      const vh = cameraVideo.videoHeight;
      const canvasAspect = w / h;
      const videoAspect = vw / vh;

      let sx, sy, sw, sh;
      if (videoAspect > canvasAspect) {
        // Video is wider than canvas ‚Äî crop sides
        sh = vh;
        sw = vh * canvasAspect;
        sx = (vw - sw) / 2;
        sy = 0;
      } else {
        // Video is taller than canvas ‚Äî crop top/bottom
        sw = vw;
        sh = vw / canvasAspect;
        sx = 0;
        sy = (vh - sh) / 2;
      }

      // drawImage(source, sourceX, sourceY, sourceW, sourceH, destX, destY, destW, destH)
      cameraCtx.drawImage(cameraVideo, sx, sy, sw, sh, 0, 0, w, h);

      // Get pixel data for manipulation
      const imageData = cameraCtx.getImageData(0, 0, w, h);
      const data = imageData.data;
      const filter = CAMERA_FILTERS[state.cameraFilterIndex];

      // Pre-calculate vignette center
      const cx = w / 2, cy = h / 2;
      const maxDist = Math.hypot(cx, cy);

      // Process every pixel
      for (let i = 0; i < data.length; i += 4) {
        let r = data[i];
        let g = data[i + 1];
        let b = data[i + 2];

        // -- Apply warmth (shift color temperature) --
        // Positive warmth adds red/yellow, negative adds blue
        r += filter.warmth;
        b -= filter.warmth * 0.5;

        // -- Apply tint (channel multipliers) --
        r *= filter.tint[0];
        g *= filter.tint[1];
        b *= filter.tint[2];

        // -- Apply saturation --
        // Convert to perceived luminance, then push channels
        // away from or toward that gray point
        const lum = 0.299 * r + 0.587 * g + 0.114 * b;
        r = lum + (r - lum) * filter.saturation;
        g = lum + (g - lum) * filter.saturation;
        b = lum + (b - lum) * filter.saturation;

        // -- Apply contrast --
        // Pivot around 128 (middle gray)
        r = ((r / 255 - 0.5) * filter.contrast + 0.5) * 255;
        g = ((g / 255 - 0.5) * filter.contrast + 0.5) * 255;
        b = ((b / 255 - 0.5) * filter.contrast + 0.5) * 255;

        // -- Apply vignette --
        // Darken pixels based on distance from center
        if (filter.vignette > 0) {
          const px = (i / 4) % w;
          const py = Math.floor((i / 4) / w);
          const dist = Math.hypot(px - cx, py - cy) / maxDist;
          // Smooth falloff curve: stronger at edges
          const vig = 1 - filter.vignette * dist * dist;
          r *= vig;
          g *= vig;
          b *= vig;
        }

        // Clamp to valid 0-255 range
        data[i] = Math.max(0, Math.min(255, r));
        data[i + 1] = Math.max(0, Math.min(255, g));
        data[i + 2] = Math.max(0, Math.min(255, b));
      }

      // Write filtered pixels back
      cameraCtx.putImageData(imageData, 0, 0);

      // Draw decorative frame/vignette on top of filtered image
      drawCameraFrame(cameraCtx, w, h);

      state.cameraAnimFrame = requestAnimationFrame(renderCamera);
    }

    // ============================================
    // PHOTO CAPTURE
    // Grabs the current filtered canvas frame and
    // triggers a download. The flash animation
    // gives visual feedback that the photo was taken.
    // ============================================
    function capturePhoto() {
      // Flash animation
      const flash = document.getElementById('cameraFlash');
      flash.classList.add('flash');
      setTimeout(() => flash.classList.remove('flash'), 150);

      // Convert canvas to blob and trigger download
      cameraCanvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        // Filename includes filter name and timestamp
        const filterName = CAMERA_FILTERS[state.cameraFilterIndex].name.replace(/[^a-z]/gi, '');
        a.download = 'PinkPony_' + filterName + '_' + Date.now() + '.jpg';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 'image/jpeg', 0.92);
    }

    // ============================================
    // TRIVIA GAME
    // 10-question rounds pulled from a bank of 50+
    // questions across 5 categories. All questions
    // are copyright-safe ‚Äî they describe themes,
    // reference career facts, and test knowledge
    // without quoting any lyrics.
    //
    // Categories:
    //   üéµ Name That Song ‚Äî describe a song's theme
    //   üé§ Career & Life  ‚Äî biographical facts
    //   üíø Album Knowledge ‚Äî track listings, release info
    //   üé™ Tours & Shows  ‚Äî live performance facts
    //   ‚ú® Superfan       ‚Äî deep cuts for real ones
    // ============================================

    let TRIVIA_QUESTIONS = [
      // ---- NAME THAT SONG ----
      {
        category: 'üéµ name that song',
        question: 'Which song tells the story of a girl from the Midwest who dreams of being a go-go dancer at a gay bar in West Hollywood?',
        answers: ['Pink Pony Club', 'Naked in Manhattan', 'Femininomenon', 'California'],
        correct: 0,
        feedback: 'Inspired by The Abbey, a famous gay bar in West Hollywood.'
      },
      {
        category: 'üéµ name that song',
        question: 'Which song is a bittersweet anthem about liking a girl who is in denial about her own sexuality?',
        answers: ['Casual', 'Good Luck, Babe!', 'Red Wine Supernova', 'Naked in Manhattan'],
        correct: 1,
        feedback: 'Released in April 2024, it became her biggest hit and reached the top 5 worldwide.'
      },
      {
        category: 'üéµ name that song',
        question: 'Which upbeat track features a crowd-participation dance move that spells out letters with your arms?',
        answers: ['Femininomenon', 'HOT TO GO!', 'Super Graphic Ultra Modern Girl', 'My Kink Is Karma'],
        correct: 1,
        feedback: 'The H-O-T-T-O-G-O dance became a viral sensation at her live shows and festivals.'
      },
      {
        category: 'üéµ name that song',
        question: 'Which song describes the frustration of being treated as unimportant in a relationship ‚Äî like the other person could take it or leave it?',
        answers: ['Coffee', 'Casual', 'After Midnight', 'Love Me Anyway'],
        correct: 1,
        feedback: 'A heartbreak anthem that became one of the standout tracks from her debut album.'
      },
      {
        category: 'üéµ name that song',
        question: 'Which track is about an instant, electric attraction to a woman ‚Äî comparing her to a cosmic event?',
        answers: ['Red Wine Supernova', 'Good Luck, Babe!', 'Naked in Manhattan', 'Pink Pony Club'],
        correct: 0,
        feedback: 'The song uses space imagery to describe an explosive romantic connection.'
      },
      {
        category: 'üéµ name that song',
        question: 'Which song captures the excitement and freedom of running around New York City with a new love interest?',
        answers: ['California', 'After Midnight', 'Naked in Manhattan', 'Picture You'],
        correct: 2,
        feedback: 'One of her first releases after rebranding, embracing her queer identity openly.'
      },
      {
        category: 'üéµ name that song',
        question: 'Which track is about wanting karma to come back around on someone who did you wrong in love?',
        answers: ['My Kink Is Karma', 'Casual', 'After Midnight', 'Love Me Anyway'],
        correct: 0,
        feedback: 'A revenge-themed bop with a catchy hook and bold attitude.'
      },
      {
        category: 'üéµ name that song',
        question: 'Which song describes feeling like every woman she encounters has an overwhelming, almost supernatural pull?',
        answers: ['HOT TO GO!', 'Red Wine Supernova', 'Femininomenon', 'Super Graphic Ultra Modern Girl'],
        correct: 2,
        feedback: 'The title is a play on "phenomenon" ‚Äî celebrating the power of femininity.'
      },
      {
        category: 'üéµ name that song',
        question: 'Which song is a moody, late-night track about sneaking out and the thrill of forbidden nightlife?',
        answers: ['After Midnight', 'Pink Pony Club', 'California', 'Coffee'],
        correct: 0,
        feedback: 'Captures the excitement and danger of nighttime escapades.'
      },
      {
        category: 'üéµ name that song',
        question: 'Which song describes being infatuated with a bold, eye-catching woman who feels like she stepped out of a comic book?',
        answers: ['Femininomenon', 'Red Wine Supernova', 'Super Graphic Ultra Modern Girl', 'HOT TO GO!'],
        correct: 2,
        feedback: 'The title itself sounds like a pop-art description of a larger-than-life crush.'
      },

      // ---- CAREER & LIFE ----
      {
        category: 'üé§ career & life',
        question: 'What is Chappell Roan\'s real name?',
        answers: ['Kayleigh Rose Amstutz', 'Charlotte Roan Mitchell', 'Chappell Rose Anderson', 'Kaylee Ann Chappell'],
        correct: 0,
        feedback: 'Born Kayleigh Rose Amstutz on February 19, 1998, in Willard, Missouri.'
      },
      {
        category: 'üé§ career & life',
        question: 'How did Chappell Roan choose her stage name?',
        answers: ['A random name generator', 'After her grandfather and his favorite song', 'It was her childhood nickname', 'Her first producer named her'],
        correct: 1,
        feedback: 'Honoring her grandfather Dennis Chappell and his favorite song "The Strawberry Roan."'
      },
      {
        category: 'üé§ career & life',
        question: 'Which major record label first signed Chappell Roan as a teenager?',
        answers: ['Island Records', 'Columbia Records', 'Atlantic Records', 'Sony Music'],
        correct: 2,
        feedback: 'She signed with Atlantic at just 17 years old after uploading music to YouTube.'
      },
      {
        category: 'üé§ career & life',
        question: 'What happened to Chappell Roan\'s first record deal?',
        answers: ['She left to go independent', 'The label merged with another', 'She was dropped in 2020', 'She renegotiated for more control'],
        correct: 2,
        feedback: 'Atlantic dropped her after "Pink Pony Club" didn\'t generate enough commercial interest at first.'
      },
      {
        category: 'üé§ career & life',
        question: 'What does Chappell Roan compare her stage persona to?',
        answers: ['A superhero alter ego', 'Hannah Montana / a drag persona', 'A character from a movie', 'Her childhood imaginary friend'],
        correct: 1,
        feedback: 'She\'s described "Chappell Roan" as her drag persona ‚Äî more open and confident than her real self.'
      },
      {
        category: 'üé§ career & life',
        question: 'Where did Chappell Roan grow up?',
        answers: ['Austin, Texas', 'Willard, Missouri', 'Nashville, Tennessee', 'Portland, Oregon'],
        correct: 1,
        feedback: 'She grew up in a small, conservative Missouri town and attended church three times a week.'
      },
      {
        category: 'üé§ career & life',
        question: 'What was the name of the first original song she uploaded to YouTube as a teenager?',
        answers: ['Good Hurt', 'Die Young', 'Pink Pony Club', 'School Nights'],
        correct: 1,
        feedback: 'Written at summer camp at the Interlochen Center for the Arts ‚Äî she said it changed her trajectory forever.'
      },
      {
        category: 'üé§ career & life',
        question: 'What award did Chappell Roan win at the 2025 Grammy Awards?',
        answers: ['Best Pop Album', 'Song of the Year', 'Best New Artist', 'Best Music Video'],
        correct: 2,
        feedback: 'She took home Best New Artist at the 2025 Grammys after her breakout year.'
      },
      {
        category: 'üé§ career & life',
        question: 'Which famous pop star\'s tour did Chappell Roan open for in 2022-2024?',
        answers: ['Taylor Swift', 'Billie Eilish', 'Olivia Rodrigo', 'Dua Lipa'],
        correct: 2,
        feedback: 'She opened for Olivia Rodrigo on the GUTS tour, which helped launch her into the mainstream.'
      },
      {
        category: 'üé§ career & life',
        question: 'What kind of work did Chappell do after being dropped from her label during the pandemic?',
        answers: ['Worked at a coffee shop and as a nanny', 'Became a studio session musician', 'Taught music lessons online', 'Worked at a record store'],
        correct: 0,
        feedback: 'She worked odd jobs including barista shifts to support herself while figuring out her next move.'
      },

      // ---- ALBUM KNOWLEDGE ----
      {
        category: 'üíø album knowledge',
        question: 'What is the title of Chappell Roan\'s debut studio album?',
        answers: ['School Nights', 'Midwest Princess', 'The Rise and Fall of a Midwest Princess', 'Good Luck, Babe!'],
        correct: 2,
        feedback: 'Released September 22, 2023, through Island Records ‚Äî it became a massive sleeper hit.'
      },
      {
        category: 'üíø album knowledge',
        question: 'What was the name of her 2017 EP released through Atlantic Records?',
        answers: ['Die Young', 'Good Hurt', 'School Nights', 'Pink Pony'],
        correct: 2,
        feedback: 'Her debut EP, released when she was 19, featured a more "witchy, dark, serious" sound.'
      },
      {
        category: 'üíø album knowledge',
        question: 'Which of these is NOT a track on "The Rise and Fall of a Midwest Princess"?',
        answers: ['Femininomenon', 'Good Luck, Babe!', 'Red Wine Supernova', 'Casual'],
        correct: 1,
        feedback: '"Good Luck, Babe!" was released in April 2024 as a standalone single ‚Äî the first song of her next chapter.'
      },
      {
        category: 'üíø album knowledge',
        question: 'Which song was the lead single that eventually went viral on TikTok in 2021, over a year after its release?',
        answers: ['Good Hurt', 'Naked in Manhattan', 'Pink Pony Club', 'HOT TO GO!'],
        correct: 2,
        feedback: 'Released April 2020 to little fanfare, it exploded on TikTok the following summer.'
      },
      {
        category: 'üíø album knowledge',
        question: 'How many tracks concurrently charted on the Billboard Hot 100 during her peak in 2024?',
        answers: ['Three', 'Four', 'Six', 'Eight'],
        correct: 2,
        feedback: 'Six tracks from her debut charted simultaneously ‚Äî an incredible feat for a debut album.'
      },
      {
        category: 'üíø album knowledge',
        question: 'Where did "Good Luck, Babe!" peak on the US Billboard Hot 100?',
        answers: ['Number 1', 'Number 4', 'Number 10', 'Number 15'],
        correct: 1,
        feedback: 'It reached number 4 and became an international top-five single.'
      },
      {
        category: 'üíø album knowledge',
        question: 'Which producer has been Chappell Roan\'s primary collaborator since 2018?',
        answers: ['Jack Antonoff', 'Dan Nigro', 'Max Martin', 'Finneas O\'Connell'],
        correct: 1,
        feedback: 'Dan Nigro has been her main producer and songwriting partner ‚Äî he also produced Olivia Rodrigo\'s debut.'
      },
      {
        category: 'üíø album knowledge',
        question: 'What genre is "The Giver," her 2025 single that debuted at #1 on the Hot Country Songs chart?',
        answers: ['Synth-pop', 'Indie rock', 'Country', 'R&B'],
        correct: 2,
        feedback: 'Her first foray into country ‚Äî she\'s only the third woman after Beyonc√© and Bebe Rexha to lead the chart with a first entry.'
      },
      {
        category: 'üíø album knowledge',
        question: 'Chappell\'s music style is most commonly described as being influenced by which decade?',
        answers: ['1970s disco', '1980s synth-pop', '1990s grunge', '2000s emo'],
        correct: 1,
        feedback: 'Her sound draws heavily from 80s synth-pop combined with campy, maximalist pop production.'
      },
      {
        category: 'üíø album knowledge',
        question: 'Which song from the debut album is described as a revenge-themed track with a bold, unapologetic attitude?',
        answers: ['After Midnight', 'Coffee', 'My Kink Is Karma', 'Casual'],
        correct: 2,
        feedback: 'One of the self-funded singles that accompanied her queer-embracing rebrand.'
      },

      // ---- TOURS & SHOWS ----
      {
        category: 'üé™ tours & shows',
        question: 'At which 2024 music festival did Chappell Roan\'s daytime set draw a bigger crowd than some headliners?',
        answers: ['Glastonbury', 'Coachella', 'SXSW', 'Reading Festival'],
        correct: 1,
        feedback: 'Her Coachella performance became a cultural moment and helped launch her into the mainstream.'
      },
      {
        category: 'üé™ tours & shows',
        question: 'What was the name of her headlining tour?',
        answers: ['The Midwest Princess Tour', 'The Rise and Fall Tour', 'The Pink Pony Tour', 'Naked in North America Tour'],
        correct: 0,
        feedback: 'The Midwest Princess Tour saw her go from small venues to sold-out shows.'
      },
      {
        category: 'üé™ tours & shows',
        question: 'Which iconic musician has publicly expressed being a fan of Chappell Roan?',
        answers: ['Madonna', 'Elton John', 'Dolly Parton', 'Stevie Nicks'],
        correct: 1,
        feedback: 'Elton John has been a vocal supporter of her music and artistry.'
      },
      {
        category: 'üé™ tours & shows',
        question: 'Which late-night TV show did Chappell Roan appear on, performing and being interviewed?',
        answers: ['Late Show with Stephen Colbert', 'The Tonight Show with Jimmy Fallon', 'Jimmy Kimmel Live', 'Late Night with Seth Meyers'],
        correct: 1,
        feedback: 'Her Tonight Show appearance was a major milestone in her mainstream breakthrough.'
      },
      {
        category: 'üé™ tours & shows',
        question: 'Which artist\'s tour did she open for in 2017, early in her career?',
        answers: ['Ed Sheeran', 'Vance Joy', 'Harry Styles', 'Hozier'],
        correct: 1,
        feedback: 'She supported Vance Joy on his Lay It On Me Tour while still on Atlantic Records.'
      },
      {
        category: 'üé™ tours & shows',
        question: 'On which TV show did Chappell first perform "The Giver" before its official release?',
        answers: ['Good Morning America', 'Saturday Night Live', 'The Tonight Show', 'The Grammy Awards'],
        correct: 1,
        feedback: 'She performed it on SNL in November 2024, months before the official March 2025 release.'
      },
      {
        category: 'üé™ tours & shows',
        question: 'Her live performances are known for their bold aesthetic inspired by which culture?',
        answers: ['Broadway musicals', 'Drag queens and camp', 'K-pop', '1970s punk'],
        correct: 1,
        feedback: 'Drag culture and camp are central to her visual identity ‚Äî from costumes to makeup to stage design.'
      },
      {
        category: 'üé™ tours & shows',
        question: 'Chappell Roan publicly spoke out about what aspect of her sudden fame?',
        answers: ['Not making enough money', 'Creepy and invasive fan behavior', 'Label disputes', 'Missing her old sound'],
        correct: 1,
        feedback: 'She set boundaries publicly, calling out behavior she considered invasive and unhealthy.'
      },

      // ---- SUPERFAN ----
      {
        category: '‚ú® superfan',
        question: 'What specific West Hollywood venue inspired "Pink Pony Club"?',
        answers: ['The Troubadour', 'The Abbey', 'The Roxy', 'Whisky a Go Go'],
        correct: 1,
        feedback: 'The Abbey is a legendary gay bar in WeHo that became her creative inspiration.'
      },
      {
        category: '‚ú® superfan',
        question: 'What was the name of Chappell Roan\'s grandfather who inspired her stage name?',
        answers: ['Robert Roan', 'Dennis Chappell', 'William Rose', 'James Amstutz'],
        correct: 1,
        feedback: 'Dennis K. Chappell, who passed away from brain cancer in 2016.'
      },
      {
        category: '‚ú® superfan',
        question: 'What was the title of her grandfather\'s favorite song, which inspired the "Roan" part of her name?',
        answers: ['The Red Pony', 'The Strawberry Roan', 'Roan Mountain', 'The Wild Mustang'],
        correct: 1,
        feedback: 'A classic cowboy poem/song by Curley Fletcher about an unrideable horse.'
      },
      {
        category: '‚ú® superfan',
        question: 'Where did Chappell write her breakout first original song "Die Young"?',
        answers: ['Her bedroom in Willard', 'A Nashville songwriting retreat', 'Interlochen Center for the Arts summer camp', 'A studio in Los Angeles'],
        correct: 2,
        feedback: 'She said that attending Interlochen "changed my trajectory forever."'
      },
      {
        category: '‚ú® superfan',
        question: 'Chappell has said the idea for her "tacky pop star" look came from conversations with whom?',
        answers: ['Her makeup artist', 'Her therapist', 'Dan Nigro', 'Her mother'],
        correct: 1,
        feedback: 'The concept emerged while discussing her inner child in therapy sessions.'
      },
      {
        category: '‚ú® superfan',
        question: 'What is Chappell Roan\'s reported height?',
        answers: ['5\'2"', '5\'5"', '5\'7"', '5\'9"'],
        correct: 0,
        feedback: 'She stands at 5 feet 2 inches ‚Äî a small-but-mighty pop powerhouse.'
      },
      {
        category: '‚ú® superfan',
        question: 'What is Chappell\'s mom\'s profession?',
        answers: ['Music teacher', 'Veterinarian', 'Nurse', 'Accountant'],
        correct: 1,
        feedback: 'Her mother Kara is a veterinarian who runs a practice in Springfield, Missouri.'
      },
      {
        category: '‚ú® superfan',
        question: 'Which Billboard honor did Chappell Roan receive for 2024?',
        answers: ['Artist of the Year', 'Top New Artist', 'Top Female Artist', 'Breakthrough International'],
        correct: 1,
        feedback: 'Billboard named her the top new artist of 2024, along with her VMA Best New Artist win.'
      },
      {
        category: '‚ú® superfan',
        question: 'After being dropped from Atlantic, Chappell moved home. What did she tell Paper Magazine about her plan?',
        answers: ['She would try acting instead', 'She gave herself one year to make it independently', 'She planned to become a songwriter for others', 'She was going to go back to school'],
        correct: 1,
        feedback: 'One year to make it ‚Äî and she did. She came back with a new look, new sound, and new label.'
      },
      {
        category: '‚ú® superfan',
        question: 'How many children are in Chappell Roan\'s family, including her?',
        answers: ['Two', 'Three', 'Four', 'Five'],
        correct: 2,
        feedback: 'She is the eldest of four children in the Amstutz family.'
      },
    ];

    // Result messages based on score ‚Äî themed for the Midwest Princess
    let TRIVIA_RESULTS = [
      { min: 0,  max: 3,  msg: 'Just getting started ‚Äî time to stream the discography on repeat!' },
      { min: 4,  max: 5,  msg: 'Casual fan energy... but we see you warming up!' },
      { min: 6,  max: 7,  msg: 'Solid knowledge! You\'re definitely on the rise.' },
      { min: 8,  max: 8,  msg: 'Impressive! You\'re a true Midwest Princess.' },
      { min: 9,  max: 9,  msg: 'Superfan status! Chappell would be proud.' },
      { min: 10, max: 10, msg: 'PERFECT SCORE! You ARE the Midwest Princess! üëë' },
    ];

    // Store Chappell's trivia in the artist config
    ARTISTS.chappell.triviaQuestions = TRIVIA_QUESTIONS;
    ARTISTS.chappell.triviaResults = TRIVIA_RESULTS;

    // Sabrina Carpenter trivia bank
    ARTISTS.sabrina.triviaQuestions = [
      // ---- NAME THAT SONG ----
      { category: 'üéµ name that song', question: 'Which song describes the addictive, can\'t-get-enough feeling of a new crush ‚Äî comparing the effect to a caffeinated drink?', answers: ['Espresso', 'Nonsense', 'Feather', 'Fast Times'], correct: 0, feedback: 'Released ahead of Coachella 2024, it became a worldwide #1 smash hit.' },
      { category: 'üéµ name that song', question: 'Which track is a desperate, pleading anthem about hoping your new partner won\'t embarrass you in public?', answers: ['Taste', 'Please Please Please', 'Slim Pickins', 'Bed Chem'], correct: 1, feedback: 'Her first US #1 on the Hot 100 ‚Äî spent weeks in the top ten.' },
      { category: 'üéµ name that song', question: 'Which song uses playful humor to deal with a love triangle, where she acknowledges the other woman but stands her ground?', answers: ['Taste', 'Lie to Girls', 'Because I Liked a Boy', 'Dumb & Poetic'], correct: 0, feedback: 'The music video became an instant sensation with its comedic horror-film style.' },
      { category: 'üéµ name that song', question: 'Which track is famous for its improvised, hilariously suggestive outros that change at every live show?', answers: ['Feather', 'Nonsense', 'Fast Times', 'Espresso'], correct: 1, feedback: 'The ever-changing outros became a beloved live tradition ‚Äî fans collect different versions.' },
      { category: 'üéµ name that song', question: 'Which upbeat song is about finally feeling free and unbothered after leaving a bad relationship?', answers: ['Feather', 'Skinny Dipping', 'Vicious', 'Because I Liked a Boy'], correct: 0, feedback: 'Reached #1 on US Pop Airplay and peaked at #21 on the Hot 100.' },
      { category: 'üéµ name that song', question: 'Which song addresses a public feud situation where she felt caught in drama just for being romantically involved with someone?', answers: ['Skin', 'Because I Liked a Boy', 'Lie to Girls', 'Nonsense'], correct: 1, feedback: 'She explored the frustration of being defined by someone else\'s narrative.' },
      { category: 'üéµ name that song', question: 'Which song explores the instant physical and emotional chemistry of a first night with someone new?', answers: ['Bed Chem', 'Espresso', 'Slim Pickins', 'Sharpest Tool'], correct: 0, feedback: 'A fan-favorite from Short n\' Sweet with its playful, intimate storytelling.' },
      { category: 'üéµ name that song', question: 'Which track\'s title was also a controversy-sparking response to another artist\'s song during a public feud?', answers: ['Because I Liked a Boy', 'Skin', 'Feather', 'Vicious'], correct: 1, feedback: 'Her first release on Island Records and first entry on the Billboard Hot 100 at #48.' },
      { category: 'üéµ name that song', question: 'Which song from Short n\' Sweet humorously laments that the dating pool is terrible?', answers: ['Dumb & Poetic', 'Slim Pickins', 'Coincidence', 'Lie to Girls'], correct: 1, feedback: 'A witty take on modern dating frustrations wrapped in a catchy melody.' },
      { category: 'üéµ name that song', question: 'Which 2025 single debuted at #1 on the Billboard Hot 100, from her album Man\'s Best Friend?', answers: ['Tears', 'Manchild', 'The Giver', 'Dumb & Poetic'], correct: 1, feedback: 'Her second US #1, "Manchild" debuted atop the Hot 100 from her seventh studio album.' },

      // ---- CAREER & LIFE ----
      { category: 'üé§ career & life', question: 'What is Sabrina Carpenter\'s full birth name?', answers: ['Sabrina Ann Carpenter', 'Sabrina Annlynn Carpenter', 'Sabrina Rose Carpenter', 'Sabrina Lynn Carpenter'], correct: 1, feedback: 'Born Sabrina Annlynn Carpenter on May 11, 1999, in Quakertown, Pennsylvania.' },
      { category: 'üé§ career & life', question: 'Which Disney Channel show made Sabrina Carpenter famous as a teenager?', answers: ['Liv and Maddie', 'Austin & Ally', 'Girl Meets World', 'Bunk\'d'], correct: 2, feedback: 'She starred as Maya Hart from 2014-2017 on this Boy Meets World spinoff.' },
      { category: 'üé§ career & life', question: 'What was Sabrina Carpenter\'s first on-screen acting role?', answers: ['Girl Meets World', 'Austin & Ally', 'Law & Order: SVU', 'Adventures in Babysitting'], correct: 2, feedback: 'She appeared in a 2011 episode of SVU at age 11 ‚Äî quite a heavy role for a debut!' },
      { category: 'üé§ career & life', question: 'Which record label did Sabrina first sign with as a young artist?', answers: ['Island Records', 'Atlantic Records', 'Hollywood Records', 'Columbia Records'], correct: 2, feedback: 'Hollywood Records is Disney\'s music label ‚Äî she released four albums with them.' },
      { category: 'üé§ career & life', question: 'Where was Sabrina Carpenter born?', answers: ['Los Angeles, California', 'Nashville, Tennessee', 'Quakertown, Pennsylvania', 'New York City, New York'], correct: 2, feedback: 'A small town in Pennsylvania ‚Äî she later moved to LA at age 13 to pursue acting.' },
      { category: 'üé§ career & life', question: 'Which famous animated character is voiced by Sabrina\'s aunt, Nancy Cartwright?', answers: ['Lisa Simpson', 'Bart Simpson', 'Dora the Explorer', 'Kim Possible'], correct: 1, feedback: 'Her paternal aunt Nancy Cartwright has voiced Bart Simpson since 1989!' },
      { category: 'üé§ career & life', question: 'Which major artist\'s tour did Sabrina open for in 2023-2024, helping launch her career?', answers: ['Billie Eilish', 'Olivia Rodrigo', 'Taylor Swift', 'Ariana Grande'], correct: 2, feedback: 'She opened 25 shows on the Eras Tour across South America, Australia, and Asia.' },
      { category: 'üé§ career & life', question: 'How many Grammy Awards did Short n\' Sweet win at the 2025 ceremony?', answers: ['One', 'Two', 'Three', 'None ‚Äî only nominated'], correct: 1, feedback: 'Best Pop Vocal Album and Best Pop Solo Performance for "Espresso."' },
      { category: 'üé§ career & life', question: 'At what age did Sabrina enter a singing competition called "The Next Miley Cyrus Project"?', answers: ['8', '10', '12', '14'], correct: 1, feedback: 'She placed third in the nationwide competition at just 10 years old.' },
      { category: 'üé§ career & life', question: 'Which prestigious magazine list was Sabrina Carpenter selected for?', answers: ['Time 100', 'Forbes 30 Under 30', 'People\'s Most Beautiful', 'Vogue 25'], correct: 1, feedback: 'She was selected for Forbes\' 30 Under 30 list recognizing her career achievements.' },

      // ---- ALBUM KNOWLEDGE ----
      { category: 'üíø album knowledge', question: 'What is the title of Sabrina Carpenter\'s sixth studio album?', answers: ['Emails I Can\'t Send', 'Short n\' Sweet', 'Man\'s Best Friend', 'Singular: Act I'], correct: 1, feedback: 'Released August 23, 2024 ‚Äî debuted at #1 on the Billboard 200 with 362,000 units.' },
      { category: 'üíø album knowledge', question: 'What was Sabrina\'s first studio album called?', answers: ['Evolution', 'Can\'t Blame a Girl', 'Eyes Wide Open', 'School Nights'], correct: 2, feedback: 'Released in 2015 through Hollywood Records while she was still on Girl Meets World.' },
      { category: 'üíø album knowledge', question: 'Which album did Sabrina call her first "big girl" album with full creative control?', answers: ['Evolution', 'Short n\' Sweet', 'Emails I Can\'t Send', 'Man\'s Best Friend'], correct: 2, feedback: 'Her 2022 album with Island Records marked her artistic rebirth with full creative freedom.' },
      { category: 'üíø album knowledge', question: 'How many studio albums has Sabrina Carpenter released as of 2025?', answers: ['Five', 'Six', 'Seven', 'Eight'], correct: 2, feedback: 'Seven albums: Eyes Wide Open, Evolution, Singular Act I & II, Emails I Can\'t Send, Short n\' Sweet, and Man\'s Best Friend.' },
      { category: 'üíø album knowledge', question: 'What is the title of the album\'s reference ‚Äî why is it called "Short n\' Sweet"?', answers: ['It\'s only 30 minutes long', 'Her shortest relationships impacted her the most', 'She\'s 5\'0" tall', 'It was a nickname from Taylor Swift'], correct: 1, feedback: 'It references how her shortest romantic relationships had the deepest emotional impact ‚Äî plus a nod to her petite stature.' },
      { category: 'üíø album knowledge', question: 'Which producer, known for working with Taylor Swift, also produced tracks on Short n\' Sweet?', answers: ['Max Martin', 'Dan Nigro', 'Jack Antonoff', 'Pharrell Williams'], correct: 2, feedback: 'Jack Antonoff, one of pop\'s most prolific producers, contributed to the album.' },
      { category: 'üíø album knowledge', question: 'What was the name of Sabrina\'s 2023 Christmas EP?', answers: ['Holly Jolly', 'A Very Sabrina Christmas', 'Fruitcake', 'Jingle Bells'], correct: 2, feedback: 'Fruitcake reached #3 on the US Top Holiday Albums chart.' },
      { category: 'üíø album knowledge', question: 'Which Sabrina Carpenter single made music history by being one of the first three top-five hits by a female artist in the same week?', answers: ['Espresso', 'Please Please Please', 'Taste', 'All three simultaneously'], correct: 3, feedback: 'She became the first act since The Beatles to chart their first three top-five hits simultaneously.' },
      { category: 'üíø album knowledge', question: 'What is the title of Sabrina\'s 2025 seventh studio album?', answers: ['Short n\' Sweet Vol. 2', 'Man\'s Best Friend', 'Hollywood Nights', 'Emails I Can\'t Send Deluxe'], correct: 1, feedback: 'Man\'s Best Friend topped the Billboard 200 and spawned the #1 single "Manchild."' },
      { category: 'üíø album knowledge', question: 'Which label does Sabrina currently release music through?', answers: ['Hollywood Records', 'Atlantic Records', 'Island Records', 'Columbia Records'], correct: 2, feedback: 'She joined Island Records in 2021, marking her creative independence from Disney.' },

      // ---- TOURS & SHOWS ----
      { category: 'üé™ tours & shows', question: 'At which 2024 music festival did Sabrina debut "Espresso" live before it was officially promoted?', answers: ['Glastonbury', 'Lollapalooza', 'Coachella', 'Gov Ball'], correct: 2, feedback: 'She trusted her instinct over her label\'s advice and debuted it at Coachella ‚Äî it went viral.' },
      { category: 'üé™ tours & shows', question: 'What was Sabrina\'s reaction when her label wanted "Please Please Please" as the lead single instead of "Espresso"?', answers: ['She agreed immediately', 'She refused and chose Espresso', 'She released both at once', 'She let fans vote'], correct: 1, feedback: 'She said she was "afraid of disappointing people for five minutes" then stuck with her gut.' },
      { category: 'üé™ tours & shows', question: 'On Taylor Swift\'s Eras Tour, which legs did Sabrina open?', answers: ['North America only', 'Europe and UK', 'South America, Australia, and Asia', 'The entire world tour'], correct: 2, feedback: 'She opened from August 2023 to March 2024 on the international legs of the tour.' },
      { category: 'üé™ tours & shows', question: 'What\'s the name of the charitable fund created with PLUS1 on Sabrina\'s tour?', answers: ['The Carpenter Foundation', 'Short n\' Sweet Fund', 'Sabrina Carpenter Fund', 'Espresso Foundation'], correct: 2, feedback: '$1 from every ticket ‚Äî it reached $1 million faster than any other PLUS1 artist partnership.' },
      { category: 'üé™ tours & shows', question: 'Which artist did Sabrina open for on the 2017 Dangerous Woman Tour?', answers: ['Taylor Swift', 'Ariana Grande', 'Beyonc√©', 'Lady Gaga'], correct: 1, feedback: 'Opening for Ariana Grande was one of her earliest big touring opportunities.' },
      { category: 'üé™ tours & shows', question: 'Sabrina\'s stage persona and style have been described as inspired by which era?', answers: ['1980s neon', '1950s and 60s vintage Hollywood', '1970s disco', '2000s Y2K'], correct: 1, feedback: 'Her hyper-feminine aesthetic features vintage silhouettes, curtain bangs, and sparkly fabrics.' },
      { category: 'üé™ tours & shows', question: 'What special collaboration happened when Sabrina returned to the Eras Tour in New Orleans?', answers: ['She performed a new unreleased song', 'She and Taylor did a mashup of Espresso and Is It Over Now', 'She joined for the entire setlist', 'She brought out a surprise third guest'], correct: 1, feedback: 'Taylor called Sabrina "live" on stage, then they performed a three-song mashup together.' },
      { category: 'üé™ tours & shows', question: 'What espresso-flavored product did Sabrina collaborate on, with half the proceeds going to charity?', answers: ['Coffee beans', 'Ice cream with Van Leeuwen', 'Energy drinks', 'Chocolate bars'], correct: 1, feedback: 'Half the earnings went to the Ali Forney Center, supporting LGBTQ+ youth.' },

      // ---- SUPERFAN ----
      { category: '‚ú® superfan', question: 'How many instruments can Sabrina play?', answers: ['Two', 'Three', 'Five', 'She doesn\'t play any'], correct: 2, feedback: 'Piano, bass, ukulele, guitar, and drums ‚Äî she played guitar on the Short n\' Sweet Tour.' },
      { category: '‚ú® superfan', question: 'How tall is Sabrina Carpenter?', answers: ['5\'0"', '5\'1"', '5\'3"', '5\'5"'], correct: 0, feedback: 'Five feet even ‚Äî her petite stature is part of the "Short n\' Sweet" double meaning.' },
      { category: '‚ú® superfan', question: 'How many siblings does Sabrina have?', answers: ['One younger brother', 'Two older sisters', 'Three older sisters', 'She\'s an only child'], correct: 2, feedback: 'She has three older sisters and was homeschooled growing up.' },
      { category: '‚ú® superfan', question: 'What did Sabrina tell Vogue about her decision to debut "Espresso" at Coachella against her label\'s wishes?', answers: ['"I was afraid for five minutes, then said no"', '"I didn\'t even think about it"', '"My manager convinced me"', '"Taylor Swift told me to do it"'], correct: 0, feedback: 'She trusted her gut about the song\'s live energy, knowing audiences would feel it immediately.' },
      { category: '‚ú® superfan', question: 'What charity did Sabrina become an ambassador for in 2016, visiting children\'s hospitals?', answers: ['Make-A-Wish', 'St. Jude', 'Ryan Seacrest Foundation', 'UNICEF'], correct: 2, feedback: 'She visited various children\'s hospitals on behalf of the Ryan Seacrest Foundation.' },
      { category: '‚ú® superfan', question: 'What streaming record did "Espresso," "Please Please Please," and "Taste" set together?', answers: ['First to hit 1 billion streams each', 'Three top-five hits in the same week ‚Äî first since The Beatles', 'Most streamed songs in a single day', 'Longest consecutive weeks in the top 10'], correct: 1, feedback: 'She became the first act since The Beatles to chart their first three top-five hits in the same week.' },
      { category: '‚ú® superfan', question: 'In which competition did a 10-year-old Sabrina place third?', answers: ['American Idol Junior', 'The Voice Kids', 'The Next Miley Cyrus Project', 'Disney\'s Star Search'], correct: 2, feedback: 'The nationwide singing competition that helped kickstart her performance career.' },
      { category: '‚ú® superfan', question: 'What did Taylor Swift say about Sabrina after her Eras Tour stint?', answers: ['"She\'s the next me"', '"Her career has skyrocketed ‚Äî it\'s the dream scenario"', '"She\'s my little sister"', '"She taught me new dance moves"'], correct: 1, feedback: 'Swift praised how Sabrina\'s career exploded after the tour, calling it the ideal trajectory.' },
      { category: '‚ú® superfan', question: 'How was Sabrina Carpenter educated as a child?', answers: ['Public school in Pennsylvania', 'Private school in LA', 'Homeschooled', 'Boarding school in New York'], correct: 2, feedback: 'Homeschooling allowed her to balance a self-paced curriculum with acting and music.' },
      { category: '‚ú® superfan', question: 'What record did Short n\' Sweet set for Sabrina on the Billboard 200?', answers: ['Longest #1 streak ever', 'Her first #1 and three consecutive weeks at the top', 'Most debut-week sales for a female artist', 'First to chart every song in the top 50'], correct: 1, feedback: 'Three weeks at #1 ‚Äî the second-longest running #1 album of 2024, behind only Taylor\'s Tortured Poets Department.' },
    ];

    ARTISTS.sabrina.triviaResults = [
      { min: 0,  max: 3,  msg: 'Time for a Short n\' Sweet deep dive! Stream the albums!' },
      { min: 4,  max: 5,  msg: 'You know the hits ‚Äî now dig into the deep cuts!' },
      { min: 6,  max: 7,  msg: 'Solid! You clearly know your Carpenter catalog.' },
      { min: 8,  max: 8,  msg: 'Impressive! That\'s that you espresso ‚Äî can\'t stop, won\'t stop.' },
      { min: 9,  max: 9,  msg: 'Superfan energy! Sabrina would be proud.' },
      { min: 10, max: 10, msg: 'PERFECT SCORE! You are Short n\' Sweet personified! ‚òïüëë' },
    ];

    // Trivia game state
    const triviaState = {
      active: false,
      questions: [],     // 10 shuffled questions for current round
      currentQ: 0,       // Which question we're on (0-9)
      score: 0,
      answered: false,   // Has user answered the current question?
    };

    // Fisher-Yates shuffle ‚Äî used to randomize questions
    // and answer order each round
    function shuffleArray(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function startTrivia() {
      // Stop any active modes
      if (state.micActive) disableMic();
      if (state.quoteMode) toggleQuoteMode();
      if (state.cameraActive) closeCamera();
      if (state.editorActive) closePhotoEditor();

      // Pick 10 random questions, ensuring category variety.
      // Shuffle the full bank, then take the first 10.
      // This gives a good mix naturally since categories
      // are roughly evenly distributed in the bank.
      const shuffled = shuffleArray(TRIVIA_QUESTIONS);
      triviaState.questions = shuffled.slice(0, 10);
      triviaState.currentQ = 0;
      triviaState.score = 0;
      triviaState.answered = false;
      triviaState.active = true;

      // Show trivia UI, hide main UI
      document.getElementById('triviaLayer').classList.add('active');
      document.getElementById('topBar').classList.add('ui-hidden');
      document.getElementById('bottomBar').classList.add('ui-hidden');

      // Show question view, hide results
      document.getElementById('triviaQuestionView').style.display = '';
      document.getElementById('triviaResultsView').style.display = 'none';

      renderTriviaQuestion();
    }

    function renderTriviaQuestion() {
      const q = triviaState.questions[triviaState.currentQ];
      const num = triviaState.currentQ + 1;

      // Update header
      document.getElementById('triviaQNum').textContent = 'Question ' + num + ' / 10';
      document.getElementById('triviaScore').textContent = 'Score: ' + triviaState.score;
      document.getElementById('triviaProgress').style.width = (num * 10) + '%';
      document.getElementById('triviaCategory').textContent = '‚ú¶ ' + q.category + ' ‚ú¶';
      document.getElementById('triviaQuestion').textContent = q.question;

      // Shuffle the answer indices so the correct answer
      // isn't always in the same position
      const indices = shuffleArray([0, 1, 2, 3]);

      // Build answer buttons
      const container = document.getElementById('triviaAnswers');
      container.innerHTML = '';

      indices.forEach((origIdx) => {
        const btn = document.createElement('button');
        btn.className = 'trivia-answer-btn';
        btn.textContent = q.answers[origIdx];
        btn.dataset.index = origIdx;
        btn.addEventListener('click', () => handleTriviaAnswer(btn, origIdx, q));
        container.appendChild(btn);
      });

      // Clear feedback and hide next button
      document.getElementById('triviaFeedback').textContent = '';
      document.getElementById('triviaNextBtn').classList.remove('visible');
      triviaState.answered = false;
    }

    function handleTriviaAnswer(btn, selectedIdx, question) {
      // Prevent double-answering
      if (triviaState.answered) return;
      triviaState.answered = true;

      const isCorrect = selectedIdx === question.correct;
      if (isCorrect) triviaState.score++;

      // Style all buttons: highlight correct, mark wrong selection
      const buttons = document.querySelectorAll('.trivia-answer-btn');
      buttons.forEach((b) => {
        const idx = parseInt(b.dataset.index);
        b.classList.add('disabled');
        if (idx === question.correct) {
          b.classList.add('correct');
        } else if (idx === selectedIdx && !isCorrect) {
          b.classList.add('wrong');
        }
      });

      // Show feedback
      const prefix = isCorrect ? '‚úì Correct! ' : '‚úó Not quite. ';
      document.getElementById('triviaFeedback').textContent = prefix + question.feedback;

      // Update score display
      document.getElementById('triviaScore').textContent = 'Score: ' + triviaState.score;

      // Show next button (or finish button if last question)
      const nextBtn = document.getElementById('triviaNextBtn');
      nextBtn.textContent = triviaState.currentQ < 9 ? 'Next ‚ú¶' : 'See Results ‚ú¶';
      nextBtn.classList.add('visible');
    }

    function nextTriviaQuestion() {
      if (triviaState.currentQ < 9) {
        triviaState.currentQ++;
        renderTriviaQuestion();
      } else {
        showTriviaResults();
      }
    }

    function showTriviaResults() {
      // Hide question view, show results
      document.getElementById('triviaQuestionView').style.display = 'none';
      document.getElementById('triviaResultsView').style.display = '';

      // Set score
      document.getElementById('triviaFinalScore').textContent =
        triviaState.score + '/10';

      // Find matching result message
      const result = TRIVIA_RESULTS.find(
        r => triviaState.score >= r.min && triviaState.score <= r.max
      );
      document.getElementById('triviaResultMsg').textContent =
        result ? result.msg : 'Great job!';
    }

    function closeTrivia() {
      triviaState.active = false;
      document.getElementById('triviaLayer').classList.remove('active');
      if (state.uiVisible) {
        document.getElementById('topBar').classList.remove('ui-hidden');
        document.getElementById('bottomBar').classList.remove('ui-hidden');
      }
    }

    // ============================================
    // PHOTO EDITOR
    // Loads an image from the device's gallery and
    // applies the same filters + frames as camera mode.
    // Unlike the live camera, this renders on-demand
    // (when filter/frame changes) instead of per-frame,
    // so we can work at full image resolution for
    // high-quality exports.
    // ============================================

    function openPhotoEditor() {
      // Trigger the hidden file input to open the OS photo picker
      document.getElementById('photoInput').click();
    }

    function handlePhotoSelected(event) {
      const file = event.target.files[0];
      if (!file) return;

      const img = new Image();
      img.onload = () => {
        state.editorImage = img;

        // Stop any active modes
        if (state.micActive) disableMic();
        if (state.quoteMode) toggleQuoteMode();
        if (state.cameraActive) closeCamera();

        // Size canvas to the image dimensions, capped for
        // performance. Images over 2000px on either side get
        // scaled down ‚Äî still much higher res than the live
        // camera canvas.
        const MAX_DIM = 2000;
        let iw = img.width;
        let ih = img.height;
        if (iw > MAX_DIM || ih > MAX_DIM) {
          const scale = MAX_DIM / Math.max(iw, ih);
          iw = Math.floor(iw * scale);
          ih = Math.floor(ih * scale);
        }
        cameraCanvas.width = iw;
        cameraCanvas.height = ih;

        // Show editor UI
        state.editorActive = true;
        document.getElementById('cameraLayer').classList.add('active');
        document.getElementById('editorControls').classList.add('active');
        document.getElementById('topBar').classList.add('ui-hidden');
        document.getElementById('bottomBar').classList.add('ui-hidden');

        // Render the photo with current filter + frame
        renderEditedPhoto();
      };

      // Read the selected file as a data URL and load into Image
      const reader = new FileReader();
      reader.onload = (e) => { img.src = e.target.result; };
      reader.readAsDataURL(file);

      // Reset the input so selecting the same file again triggers change
      event.target.value = '';
    }

    function renderEditedPhoto() {
      if (!state.editorActive || !state.editorImage) return;

      const img = state.editorImage;
      const w = cameraCanvas.width;
      const h = cameraCanvas.height;

      // Draw the original image scaled to canvas
      // Uses cover-fit same as camera mode
      const imgAspect = img.width / img.height;
      const canAspect = w / h;

      let sx, sy, sw, sh;
      if (imgAspect > canAspect) {
        sh = img.height;
        sw = img.height * canAspect;
        sx = (img.width - sw) / 2;
        sy = 0;
      } else {
        sw = img.width;
        sh = img.width / canAspect;
        sx = 0;
        sy = (img.height - sh) / 2;
      }

      cameraCtx.drawImage(img, sx, sy, sw, sh, 0, 0, w, h);

      // Apply pixel filter (same code as camera mode)
      const filter = CAMERA_FILTERS[state.editorFilterIndex];
      const imageData = cameraCtx.getImageData(0, 0, w, h);
      const data = imageData.data;
      const cx = w / 2, cy = h / 2;
      const maxDist = Math.hypot(cx, cy);

      for (let i = 0; i < data.length; i += 4) {
        let r = data[i];
        let g = data[i + 1];
        let b = data[i + 2];

        r += filter.warmth;
        b -= filter.warmth * 0.5;
        r *= filter.tint[0];
        g *= filter.tint[1];
        b *= filter.tint[2];

        const lum = 0.299 * r + 0.587 * g + 0.114 * b;
        r = lum + (r - lum) * filter.saturation;
        g = lum + (g - lum) * filter.saturation;
        b = lum + (b - lum) * filter.saturation;

        r = ((r / 255 - 0.5) * filter.contrast + 0.5) * 255;
        g = ((g / 255 - 0.5) * filter.contrast + 0.5) * 255;
        b = ((b / 255 - 0.5) * filter.contrast + 0.5) * 255;

        if (filter.vignette > 0) {
          const px = (i / 4) % w;
          const py = Math.floor((i / 4) / w);
          const dist = Math.hypot(px - cx, py - cy) / maxDist;
          const vig = 1 - filter.vignette * dist * dist;
          r *= vig;
          g *= vig;
          b *= vig;
        }

        data[i] = Math.max(0, Math.min(255, r));
        data[i + 1] = Math.max(0, Math.min(255, g));
        data[i + 2] = Math.max(0, Math.min(255, b));
      }

      cameraCtx.putImageData(imageData, 0, 0);

      // Draw frame on top ‚Äî reuse the same frame system
      // Temporarily swap in editor's frame index
      const savedFrameIdx = state.cameraFrameIndex;
      state.cameraFrameIndex = state.editorFrameIndex;
      drawCameraFrame(cameraCtx, w, h);
      state.cameraFrameIndex = savedFrameIdx;
    }

    function closePhotoEditor() {
      state.editorActive = false;
      state.editorImage = null;
      document.getElementById('cameraLayer').classList.remove('active');
      document.getElementById('editorControls').classList.remove('active');
      if (state.uiVisible) {
        document.getElementById('topBar').classList.remove('ui-hidden');
        document.getElementById('bottomBar').classList.remove('ui-hidden');
      }
    }

    function cycleEditorFilter() {
      state.editorFilterIndex = (state.editorFilterIndex + 1) % CAMERA_FILTERS.length;
      document.getElementById('editorFilterName').textContent =
        '‚ú¶ ' + CAMERA_FILTERS[state.editorFilterIndex].name + ' ‚ú¶';
      renderEditedPhoto();
    }

    function cycleEditorFrame() {
      state.editorFrameIndex = (state.editorFrameIndex + 1) % CAMERA_FRAMES.length;
      const name = CAMERA_FRAMES[state.editorFrameIndex].name;
      document.getElementById('editorFrameName').textContent =
        state.editorFrameIndex === 0 ? '' : '‚¨• ' + name;
      renderEditedPhoto();
    }

    function saveEditedPhoto() {
      // Flash feedback
      const flash = document.getElementById('cameraFlash');
      flash.classList.add('flash');
      setTimeout(() => flash.classList.remove('flash'), 150);

      cameraCanvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const filterName = CAMERA_FILTERS[state.editorFilterIndex].name.replace(/[^a-z]/gi, '');
        a.download = 'PinkPony_Edit_' + filterName + '_' + Date.now() + '.jpg';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 'image/jpeg', 0.92);
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================

    // Artist picker on start screen
    const pickChappell = document.getElementById('pickChappell');
    const pickSabrina = document.getElementById('pickSabrina');

    pickChappell.addEventListener('click', () => {
      pickChappell.classList.add('selected');
      pickSabrina.classList.remove('selected');
      switchArtist('chappell');
      document.getElementById('startTitle').innerHTML = ARTISTS.chappell.title;
      document.getElementById('startSubtitle').textContent = ARTISTS.chappell.subtitle;
    });

    pickSabrina.addEventListener('click', () => {
      pickSabrina.classList.add('selected');
      pickChappell.classList.remove('selected');
      switchArtist('sabrina');
      document.getElementById('startTitle').innerHTML = ARTISTS.sabrina.title;
      document.getElementById('startSubtitle').textContent = ARTISTS.sabrina.subtitle;
    });

    // Start
    document.getElementById('startBtn').addEventListener('click', async () => {
      const prompt = document.getElementById('startPrompt');
      prompt.classList.add('leaving');
      setTimeout(() => prompt.classList.add('hidden'), 600);
      await enableMic();
      render();
    });

    // Controls
    document.getElementById('btnMic').addEventListener('click', () => {
      state.micActive ? disableMic() : enableMic();
    });

    document.getElementById('btnFractal').addEventListener('click', () => {
      state.fractalType = (state.fractalType + 1) % FRACTAL_TYPES.length;
      updateInfoText();
    });

    document.getElementById('btnPalette').addEventListener('click', cycleUITheme);
    document.getElementById('btnColors').addEventListener('click', cycleFractalColors);
    document.getElementById('btnFullscreen').addEventListener('click', toggleFullscreen);

    // Camera mode
    document.getElementById('btnCamera').addEventListener('click', openCamera);
    document.getElementById('btnCamClose').addEventListener('click', closeCamera);
    document.getElementById('btnCamFilter').addEventListener('click', cycleCameraFilter);
    document.getElementById('btnCamFrame').addEventListener('click', cycleCameraFrame);
    document.getElementById('btnCamFlip').addEventListener('click', flipCamera);
    document.getElementById('btnShutter').addEventListener('click', capturePhoto);

    // Photo editor mode
    document.getElementById('btnEditPhoto').addEventListener('click', openPhotoEditor);
    document.getElementById('photoInput').addEventListener('change', handlePhotoSelected);
    document.getElementById('btnEdFilter').addEventListener('click', cycleEditorFilter);
    document.getElementById('btnEdFrame').addEventListener('click', cycleEditorFrame);
    document.getElementById('btnEdSave').addEventListener('click', saveEditedPhoto);
    document.getElementById('btnEdPick').addEventListener('click', openPhotoEditor);
    document.getElementById('btnEdClose').addEventListener('click', closePhotoEditor);

    // Trivia mode
    document.getElementById('btnTrivia').addEventListener('click', startTrivia);
    document.getElementById('triviaNextBtn').addEventListener('click', nextTriviaQuestion);
    document.getElementById('triviaPlayAgain').addEventListener('click', startTrivia);
    document.getElementById('triviaExit').addEventListener('click', closeTrivia);
    document.getElementById('triviaCloseBtn').addEventListener('click', closeTrivia);

    // Quote mode toggle
    document.getElementById('btnQuotes').addEventListener('click', toggleQuoteMode);

    // Edit quotes modal
    document.getElementById('btnEditQuotes').addEventListener('click', openQuoteModal);
    document.getElementById('modalClose').addEventListener('click', closeQuoteModal);

    // Close modal when clicking backdrop (outside the panel)
    document.getElementById('quoteModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('quoteModal')) closeQuoteModal();
    });

    // Add quote button and Enter key in input
    document.getElementById('addQuoteBtn').addEventListener('click', addCustomQuote);
    document.getElementById('newQuoteInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') addCustomQuote();
    });

    // Tap canvas to also advance quote (if in quote mode)
    document.getElementById('tapTarget').addEventListener('click', () => {
      if (state.quoteMode) {
        // In quote mode, tap cycles quotes instead of hiding UI
        nextQuote();
      } else {
        toggleUI();
      }
    });

    // Sensitivity
    document.getElementById('sensitivity').addEventListener('input', (e) => {
      state.sensitivity = e.target.value / 50;
    });

    // Resize
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // ============================================
    // SERVICE WORKER REGISTRATION
    // Registers sw.js which caches the app for
    // offline use and enables PWA installability.
    // The 'if' check ensures we only try in
    // browsers that support service workers.
    // ============================================
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((reg) => console.log('[PWA] Service worker registered:', reg.scope))
          .catch((err) => console.warn('[PWA] SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
